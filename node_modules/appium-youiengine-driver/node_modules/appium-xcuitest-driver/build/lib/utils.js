"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.detectUdid = detectUdid;
exports.getAndCheckXcodeVersion = getAndCheckXcodeVersion;
exports.getAndCheckIosSdkVersion = getAndCheckIosSdkVersion;
exports.getGenericSimulatorForIosVersion = getGenericSimulatorForIosVersion;
exports.checkAppPresent = checkAppPresent;
exports.getDriverInfo = getDriverInfo;
exports.clearSystemFiles = clearSystemFiles;
exports.translateDeviceName = translateDeviceName;
exports.normalizeCommandTimeouts = normalizeCommandTimeouts;
exports.markSystemFilesForCleanup = markSystemFilesForCleanup;
exports.printUser = printUser;
exports.getPIDsListeningOnPort = getPIDsListeningOnPort;
exports.encodeBase64OrUpload = encodeBase64OrUpload;
exports.removeAllSessionWebSocketHandlers = removeAllSessionWebSocketHandlers;
exports.verifyApplicationPlatform = verifyApplicationPlatform;
exports.isLocalHost = isLocalHost;
exports.normalizePlatformVersion = normalizePlatformVersion;
exports.DEFAULT_TIMEOUT_KEY = void 0;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumIosDevice = require("appium-ios-device");

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDriver = require("appium-ios-driver");

var _teen_process = require("teen_process");

var _appiumXcode = _interopRequireDefault(require("appium-xcode"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _iosGenericSimulators = _interopRequireDefault(require("./ios-generic-simulators"));

var _url = _interopRequireDefault(require("url"));

var _os = _interopRequireDefault(require("os"));

var _semver = _interopRequireDefault(require("semver"));

const DEFAULT_TIMEOUT_KEY = 'default';
exports.DEFAULT_TIMEOUT_KEY = DEFAULT_TIMEOUT_KEY;
const XCTEST_LOG_FILES_PATTERNS = [/^Session-WebDriverAgentRunner.*\.log$/i, /^StandardOutputAndStandardError\.txt$/i];
const XCTEST_LOGS_CACHE_FOLDER_PREFIX = 'com.apple.dt.XCTest';

async function detectUdid() {
  _logger.default.debug('Auto-detecting real device udid...');

  const udids = await _appiumIosDevice.utilities.getConnectedDevices();

  if (_lodash.default.isEmpty(udids)) {
    throw new Error('No device is connected to the host');
  }

  const udid = _lodash.default.last(udids);

  if (udids.length > 1) {
    _logger.default.warn(`Multiple devices found: ${udids.join(', ')}`);

    _logger.default.warn(`Choosing '${udid}'. If this is wrong, manually set with 'udid' desired capability`);
  }

  _logger.default.debug(`Detected real device udid: '${udid}'`);

  return udid;
}

async function getAndCheckXcodeVersion() {
  let version;

  try {
    version = await _appiumXcode.default.getVersion(true);
  } catch (err) {
    _logger.default.debug(err);

    _logger.default.errorAndThrow(`Could not determine Xcode version: ${err.message}`);
  }

  if (version.versionFloat < 7.3) {
    _logger.default.errorAndThrow(`Xcode version '${version.versionString}'. Support for ` + `Xcode ${version.versionString} is not supported. ` + `Please upgrade to version 7.3 or higher`);
  }

  return version;
}

async function getAndCheckIosSdkVersion() {
  try {
    return await _appiumXcode.default.getMaxIOSSDK();
  } catch (err) {
    _logger.default.errorAndThrow(`Could not determine iOS SDK version: ${err.message}`);
  }
}

function getGenericSimulatorForIosVersion(platformVersion, deviceName) {
  let genericSimulators = _iosGenericSimulators.default[deviceName];

  if (genericSimulators) {
    genericSimulators = genericSimulators.sort(([simOne], [simTwo]) => _appiumSupport.util.compareVersions(simOne, '<', simTwo) ? -1 : 1);
    let genericIosSimulator;

    for (const [platformVersionFromList, iosSimulator] of genericSimulators) {
      if (_appiumSupport.util.compareVersions(platformVersionFromList, '>', platformVersion)) {
        break;
      }

      genericIosSimulator = iosSimulator;
    }

    return genericIosSimulator;
  }
}

function translateDeviceName(platformVersion, deviceName = '') {
  const deviceNameTranslated = getGenericSimulatorForIosVersion(platformVersion, deviceName.toLowerCase().trim());

  if (deviceNameTranslated) {
    _logger.default.debug(`Changing deviceName from '${deviceName}' to '${deviceNameTranslated}'`);

    return deviceNameTranslated;
  }

  return deviceName;
}

const derivedDataCleanupMarkers = new Map();

async function markSystemFilesForCleanup(wda) {
  if (!wda || !(await wda.retrieveDerivedDataPath())) {
    _logger.default.warn('No WebDriverAgent derived data available, so unable to mark system files for cleanup');

    return;
  }

  const logsRoot = _path.default.resolve(await wda.retrieveDerivedDataPath(), 'Logs');

  let markersCount = 0;

  if (derivedDataCleanupMarkers.has(logsRoot)) {
    markersCount = derivedDataCleanupMarkers.get(logsRoot);
  }

  derivedDataCleanupMarkers.set(logsRoot, ++markersCount);
}

async function clearSystemFiles(wda) {
  if (!wda || !(await wda.retrieveDerivedDataPath())) {
    _logger.default.warn('No WebDriverAgent derived data available, so unable to clear system files');

    return;
  }

  const logsRoot = _path.default.resolve(await wda.retrieveDerivedDataPath(), 'Logs');

  if (derivedDataCleanupMarkers.has(logsRoot)) {
    let markersCount = derivedDataCleanupMarkers.get(logsRoot);
    derivedDataCleanupMarkers.set(logsRoot, --markersCount);

    if (markersCount > 0) {
      _logger.default.info(`Not cleaning '${logsRoot}' folder, because the other session does not expect it to be cleaned`);

      return;
    }
  }

  derivedDataCleanupMarkers.set(logsRoot, 0);
  const globPattern = `${_os.default.tmpdir()}/${XCTEST_LOGS_CACHE_FOLDER_PREFIX}*/`;
  const dstFolders = await _appiumSupport.fs.glob(globPattern);

  if (_lodash.default.isEmpty(dstFolders)) {
    _logger.default.debug(`Did not find the temporary XCTest logs root at '${globPattern}'`);
  } else {
    for (const dstFolder of dstFolders) {
      let scheduledFilesCount = 0;

      _bluebird.default.resolve(_appiumSupport.fs.walkDir(dstFolder, true, (itemPath, isDir) => {
        if (isDir) {
          return;
        }

        const fileName = _path.default.basename(itemPath);

        if (!XCTEST_LOG_FILES_PATTERNS.some(p => p.test(fileName))) {
          return;
        }

        _appiumSupport.fs.unlink(itemPath).catch(e => {
          _logger.default.info(e.message);
        });

        scheduledFilesCount++;
      })).finally(() => {
        if (scheduledFilesCount > 0) {
          _logger.default.info(`Scheduled ${scheduledFilesCount} temporary XCTest log ` + `${_appiumSupport.util.pluralize('file', scheduledFilesCount)} for cleanup in '${dstFolder}'`);
        }
      }).catch(e => {
        _logger.default.info(e.message);
      });
    }

    _logger.default.debug(`Started background XCTest logs cleanup in '${dstFolders}'`);
  }

  if (await _appiumSupport.fs.exists(logsRoot)) {
    _logger.default.info(`Cleaning test logs in '${logsRoot}' folder`);

    await _appiumIosDriver.utils.clearLogs([logsRoot]);
    return;
  }

  _logger.default.info(`There is no ${logsRoot} folder, so not cleaning files`);
}

async function checkAppPresent(app) {
  _logger.default.debug(`Checking whether app '${app}' is actually present on file system`);

  if (!(await _appiumSupport.fs.exists(app))) {
    _logger.default.errorAndThrow(`Could not find app at '${app}'`);
  }

  _logger.default.debug('App is present');
}

async function getDriverInfo() {
  const stat = await _appiumSupport.fs.stat(_path.default.resolve(__dirname, '..'));
  const built = stat.mtime.getTime();

  const pkg = require(__filename.includes('build/lib/utils') ? '../../package.json' : '../package.json');

  const version = pkg.version;
  return {
    built,
    version
  };
}

function normalizeCommandTimeouts(value) {
  if (typeof value !== 'string') {
    return value;
  }

  let result = {};

  if (!isNaN(value)) {
    result[DEFAULT_TIMEOUT_KEY] = _lodash.default.toInteger(value);
    return result;
  }

  try {
    result = JSON.parse(value);

    if (!_lodash.default.isPlainObject(result)) {
      throw new Error();
    }
  } catch (err) {
    _logger.default.errorAndThrow(`"commandTimeouts" capability should be a valid JSON object. "${value}" was given instead`);
  }

  for (let [cmd, timeout] of _lodash.default.toPairs(result)) {
    if (!_lodash.default.isInteger(timeout) || timeout <= 0) {
      _logger.default.errorAndThrow(`The timeout for "${cmd}" should be a valid natural number of milliseconds. "${timeout}" was given instead`);
    }
  }

  return result;
}

async function printUser() {
  try {
    let {
      stdout
    } = await (0, _teen_process.exec)('whoami');

    _logger.default.debug(`Current user: '${stdout.trim()}'`);
  } catch (err) {
    _logger.default.debug(`Unable to get username running server: ${err.message}`);
  }
}

async function getPIDsListeningOnPort(port, filteringFunc = null) {
  const result = [];

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)('lsof', ['-ti', `tcp:${port}`]);
    result.push(...stdout.trim().split(/\n+/));
  } catch (e) {
    return result;
  }

  if (!_lodash.default.isFunction(filteringFunc)) {
    return result;
  }

  return await _bluebird.default.filter(result, async x => {
    const {
      stdout
    } = await (0, _teen_process.exec)('ps', ['-p', x, '-o', 'command']);
    return await filteringFunc(stdout);
  });
}

async function encodeBase64OrUpload(localPath, remotePath = null, uploadOptions = {}) {
  if (!(await _appiumSupport.fs.exists(localPath))) {
    _logger.default.errorAndThrow(`The file at '${localPath}' does not exist or is not accessible`);
  }

  if (_lodash.default.isEmpty(remotePath)) {
    const {
      size
    } = await _appiumSupport.fs.stat(localPath);

    _logger.default.debug(`The size of the file is ${_appiumSupport.util.toReadableSizeString(size)}`);

    return (await _appiumSupport.util.toInMemoryBase64(localPath)).toString();
  }

  const {
    user,
    pass,
    method,
    headers,
    fileFieldName,
    formFields
  } = uploadOptions;
  const options = {
    method: method || 'PUT',
    headers,
    fileFieldName,
    formFields
  };

  if (user && pass) {
    options.auth = {
      user,
      pass
    };
  }

  await _appiumSupport.net.uploadFile(localPath, remotePath, options);
  return '';
}

async function removeAllSessionWebSocketHandlers(server, sessionId) {
  if (!server || !_lodash.default.isFunction(server.getWebSocketHandlers)) {
    return;
  }

  const activeHandlers = await server.getWebSocketHandlers(sessionId);

  for (const pathname of _lodash.default.keys(activeHandlers)) {
    await server.removeWebSocketHandler(pathname);
  }
}

async function verifyApplicationPlatform(app, expectedPlatform) {
  _logger.default.debug('Verifying application platform');

  const infoPlist = _path.default.resolve(app, 'Info.plist');

  if (!(await _appiumSupport.fs.exists(infoPlist))) {
    _logger.default.debug(`'${infoPlist}' does not exist`);

    return;
  }

  const {
    CFBundleSupportedPlatforms
  } = await _appiumSupport.plist.parsePlistFile(infoPlist);

  _logger.default.debug(`CFBundleSupportedPlatforms: ${JSON.stringify(CFBundleSupportedPlatforms)}`);

  if (!_lodash.default.isArray(CFBundleSupportedPlatforms)) {
    _logger.default.debug(`CFBundleSupportedPlatforms key does not exist in '${infoPlist}'`);

    return;
  }

  const {
    isSimulator,
    isTvOS
  } = expectedPlatform;
  const prefix = isTvOS ? 'AppleTV' : 'iPhone';
  const suffix = isSimulator ? 'Simulator' : 'OS';
  const dstPlatform = `${prefix}${suffix}`;

  if (!CFBundleSupportedPlatforms.includes(dstPlatform)) {
    throw new Error(`${isSimulator ? 'Simulator' : 'Real device'} architecture is unsupported by the '${app}' application. ` + `Make sure the correct deployment target has been selected for its compilation in Xcode.`);
  }
}

function isLocalHost(urlString) {
  try {
    const {
      hostname
    } = _url.default.parse(urlString);

    return ['localhost', '127.0.0.1', '::1', '::ffff:127.0.0.1'].includes(hostname);
  } catch (ign) {
    _logger.default.warn(`'${urlString}' cannot be parsed as a valid URL`);
  }

  return false;
}

function normalizePlatformVersion(originalVersion) {
  const normalizedVersion = _semver.default.coerce(originalVersion);

  if (!normalizedVersion) {
    throw new Error(`The platform version '${originalVersion}' should be a valid version number`);
  }

  return `${normalizedVersion.major}.${normalizedVersion.minor}`;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlscy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1RJTUVPVVRfS0VZIiwiWENURVNUX0xPR19GSUxFU19QQVRURVJOUyIsIlhDVEVTVF9MT0dTX0NBQ0hFX0ZPTERFUl9QUkVGSVgiLCJkZXRlY3RVZGlkIiwibG9nIiwiZGVidWciLCJ1ZGlkcyIsInV0aWxpdGllcyIsImdldENvbm5lY3RlZERldmljZXMiLCJfIiwiaXNFbXB0eSIsIkVycm9yIiwidWRpZCIsImxhc3QiLCJsZW5ndGgiLCJ3YXJuIiwiam9pbiIsImdldEFuZENoZWNrWGNvZGVWZXJzaW9uIiwidmVyc2lvbiIsInhjb2RlIiwiZ2V0VmVyc2lvbiIsImVyciIsImVycm9yQW5kVGhyb3ciLCJtZXNzYWdlIiwidmVyc2lvbkZsb2F0IiwidmVyc2lvblN0cmluZyIsImdldEFuZENoZWNrSW9zU2RrVmVyc2lvbiIsImdldE1heElPU1NESyIsImdldEdlbmVyaWNTaW11bGF0b3JGb3JJb3NWZXJzaW9uIiwicGxhdGZvcm1WZXJzaW9uIiwiZGV2aWNlTmFtZSIsImdlbmVyaWNTaW11bGF0b3JzIiwiaW9zR2VuZXJpY1NpbXVsYXRvcnMiLCJzb3J0Iiwic2ltT25lIiwic2ltVHdvIiwidXRpbCIsImNvbXBhcmVWZXJzaW9ucyIsImdlbmVyaWNJb3NTaW11bGF0b3IiLCJwbGF0Zm9ybVZlcnNpb25Gcm9tTGlzdCIsImlvc1NpbXVsYXRvciIsInRyYW5zbGF0ZURldmljZU5hbWUiLCJkZXZpY2VOYW1lVHJhbnNsYXRlZCIsInRvTG93ZXJDYXNlIiwidHJpbSIsImRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMiLCJNYXAiLCJtYXJrU3lzdGVtRmlsZXNGb3JDbGVhbnVwIiwid2RhIiwicmV0cmlldmVEZXJpdmVkRGF0YVBhdGgiLCJsb2dzUm9vdCIsInBhdGgiLCJyZXNvbHZlIiwibWFya2Vyc0NvdW50IiwiaGFzIiwiZ2V0Iiwic2V0IiwiY2xlYXJTeXN0ZW1GaWxlcyIsImluZm8iLCJnbG9iUGF0dGVybiIsIm9zIiwidG1wZGlyIiwiZHN0Rm9sZGVycyIsImZzIiwiZ2xvYiIsImRzdEZvbGRlciIsInNjaGVkdWxlZEZpbGVzQ291bnQiLCJCIiwid2Fsa0RpciIsIml0ZW1QYXRoIiwiaXNEaXIiLCJmaWxlTmFtZSIsImJhc2VuYW1lIiwic29tZSIsInAiLCJ0ZXN0IiwidW5saW5rIiwiY2F0Y2giLCJlIiwiZmluYWxseSIsInBsdXJhbGl6ZSIsImV4aXN0cyIsImlvc1V0aWxzIiwiY2xlYXJMb2dzIiwiY2hlY2tBcHBQcmVzZW50IiwiYXBwIiwiZ2V0RHJpdmVySW5mbyIsInN0YXQiLCJfX2Rpcm5hbWUiLCJidWlsdCIsIm10aW1lIiwiZ2V0VGltZSIsInBrZyIsInJlcXVpcmUiLCJfX2ZpbGVuYW1lIiwiaW5jbHVkZXMiLCJub3JtYWxpemVDb21tYW5kVGltZW91dHMiLCJ2YWx1ZSIsInJlc3VsdCIsImlzTmFOIiwidG9JbnRlZ2VyIiwiSlNPTiIsInBhcnNlIiwiaXNQbGFpbk9iamVjdCIsImNtZCIsInRpbWVvdXQiLCJ0b1BhaXJzIiwiaXNJbnRlZ2VyIiwicHJpbnRVc2VyIiwic3Rkb3V0IiwiZ2V0UElEc0xpc3RlbmluZ09uUG9ydCIsInBvcnQiLCJmaWx0ZXJpbmdGdW5jIiwicHVzaCIsInNwbGl0IiwiaXNGdW5jdGlvbiIsImZpbHRlciIsIngiLCJlbmNvZGVCYXNlNjRPclVwbG9hZCIsImxvY2FsUGF0aCIsInJlbW90ZVBhdGgiLCJ1cGxvYWRPcHRpb25zIiwic2l6ZSIsInRvUmVhZGFibGVTaXplU3RyaW5nIiwidG9Jbk1lbW9yeUJhc2U2NCIsInRvU3RyaW5nIiwidXNlciIsInBhc3MiLCJtZXRob2QiLCJoZWFkZXJzIiwiZmlsZUZpZWxkTmFtZSIsImZvcm1GaWVsZHMiLCJvcHRpb25zIiwiYXV0aCIsIm5ldCIsInVwbG9hZEZpbGUiLCJyZW1vdmVBbGxTZXNzaW9uV2ViU29ja2V0SGFuZGxlcnMiLCJzZXJ2ZXIiLCJzZXNzaW9uSWQiLCJnZXRXZWJTb2NrZXRIYW5kbGVycyIsImFjdGl2ZUhhbmRsZXJzIiwicGF0aG5hbWUiLCJrZXlzIiwicmVtb3ZlV2ViU29ja2V0SGFuZGxlciIsInZlcmlmeUFwcGxpY2F0aW9uUGxhdGZvcm0iLCJleHBlY3RlZFBsYXRmb3JtIiwiaW5mb1BsaXN0IiwiQ0ZCdW5kbGVTdXBwb3J0ZWRQbGF0Zm9ybXMiLCJwbGlzdCIsInBhcnNlUGxpc3RGaWxlIiwic3RyaW5naWZ5IiwiaXNBcnJheSIsImlzU2ltdWxhdG9yIiwiaXNUdk9TIiwicHJlZml4Iiwic3VmZml4IiwiZHN0UGxhdGZvcm0iLCJpc0xvY2FsSG9zdCIsInVybFN0cmluZyIsImhvc3RuYW1lIiwidXJsIiwiaWduIiwibm9ybWFsaXplUGxhdGZvcm1WZXJzaW9uIiwib3JpZ2luYWxWZXJzaW9uIiwibm9ybWFsaXplZFZlcnNpb24iLCJzZW12ZXIiLCJjb2VyY2UiLCJtYWpvciIsIm1pbm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsbUJBQW1CLEdBQUcsU0FBNUI7O0FBQ0EsTUFBTUMseUJBQXlCLEdBQUcsQ0FDaEMsd0NBRGdDLEVBRWhDLHdDQUZnQyxDQUFsQztBQUlBLE1BQU1DLCtCQUErQixHQUFHLHFCQUF4Qzs7QUFHQSxlQUFlQyxVQUFmLEdBQTZCO0FBQzNCQyxrQkFBSUMsS0FBSixDQUFVLG9DQUFWOztBQUNBLFFBQU1DLEtBQUssR0FBRyxNQUFNQywyQkFBVUMsbUJBQVYsRUFBcEI7O0FBQ0EsTUFBSUMsZ0JBQUVDLE9BQUYsQ0FBVUosS0FBVixDQUFKLEVBQXNCO0FBQ3BCLFVBQU0sSUFBSUssS0FBSixDQUFVLG9DQUFWLENBQU47QUFDRDs7QUFDRCxRQUFNQyxJQUFJLEdBQUdILGdCQUFFSSxJQUFGLENBQU9QLEtBQVAsQ0FBYjs7QUFDQSxNQUFJQSxLQUFLLENBQUNRLE1BQU4sR0FB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R0FBaUIsSUFBM0M7QUFDQSxRQUFNSSxXQUFXLEdBQUksR0FBRUYsTUFBTyxHQUFFQyxNQUFPLEVBQXZDOztBQUNBLE1BQUksQ0FBQ1IsMEJBQTBCLENBQUNwRCxRQUEzQixDQUFvQzZELFdBQXBDLENBQUwsRUFBdUQ7QUFDckQsVUFBTSxJQUFJakosS0FBSixDQUFXLEdBQUU2SSxXQUFXLEdBQUcsV0FBSCxHQUFpQixhQUFjLHdDQUF1Q25FLEdBQUksaUJBQXhGLEdBQ2IseUZBREcsQ0FBTjtBQUVEO0FBQ0Y7O0FBT0QsU0FBU3dFLFdBQVQsQ0FBc0JDLFNBQXRCLEVBQWlDO0FBQy9CLE1BQUk7QUFDRixVQUFNO0FBQUNDLE1BQUFBO0FBQUQsUUFBYUMsYUFBSTFELEtBQUosQ0FBVXdELFNBQVYsQ0FBbkI7O0FBQ0EsV0FBTyxDQUFDLFdBQUQsRUFBYyxXQUFkLEVBQTJCLEtBQTNCLEVBQWtDLGtCQUFsQyxFQUFzRC9ELFFBQXRELENBQStEZ0UsUUFBL0QsQ0FBUDtBQUNELEdBSEQsQ0FHRSxPQUFPRSxHQUFQLEVBQVk7QUFDWjdKLG9CQUFJVyxJQUFKLENBQVUsSUFBRytJLFNBQVUsbUNBQXZCO0FBQ0Q7O0FBQ0QsU0FBTyxLQUFQO0FBQ0Q7O0FBU0QsU0FBU0ksd0JBQVQsQ0FBbUNDLGVBQW5DLEVBQW9EO0FBQ2xELFFBQU1DLGlCQUFpQixHQUFHQyxnQkFBT0MsTUFBUCxDQUFjSCxlQUFkLENBQTFCOztBQUNBLE1BQUksQ0FBQ0MsaUJBQUwsRUFBd0I7QUFDdEIsVUFBTSxJQUFJekosS0FBSixDQUFXLHlCQUF3QndKLGVBQWdCLG9DQUFuRCxDQUFOO0FBQ0Q7O0FBQ0QsU0FBUSxHQUFFQyxpQkFBaUIsQ0FBQ0csS0FBTSxJQUFHSCxpQkFBaUIsQ0FBQ0ksS0FBTSxFQUE3RDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgdXRpbGl0aWVzIH0gZnJvbSAnYXBwaXVtLWlvcy1kZXZpY2UnO1xuaW1wb3J0IHsgZnMsIHV0aWwsIG5ldCwgcGxpc3QgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHV0aWxzIGFzIGlvc1V0aWxzIH0gZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBpb3NHZW5lcmljU2ltdWxhdG9ycyBmcm9tICcuL2lvcy1nZW5lcmljLXNpbXVsYXRvcnMnO1xuaW1wb3J0IHVybCBmcm9tICd1cmwnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcblxuXG5jb25zdCBERUZBVUxUX1RJTUVPVVRfS0VZID0gJ2RlZmF1bHQnO1xuY29uc3QgWENURVNUX0xPR19GSUxFU19QQVRURVJOUyA9IFtcbiAgL15TZXNzaW9uLVdlYkRyaXZlckFnZW50UnVubmVyLipcXC5sb2ckL2ksXG4gIC9eU3RhbmRhcmRPdXRwdXRBbmRTdGFuZGFyZEVycm9yXFwudHh0JC9pLFxuXTtcbmNvbnN0IFhDVEVTVF9MT0dTX0NBQ0hFX0ZPTERFUl9QUkVGSVggPSAnY29tLmFwcGxlLmR0LlhDVGVzdCc7XG5cblxuYXN5bmMgZnVuY3Rpb24gZGV0ZWN0VWRpZCAoKSB7XG4gIGxvZy5kZWJ1ZygnQXV0by1kZXRlY3RpbmcgcmVhbCBkZXZpY2UgdWRpZC4uLicpO1xuICBjb25zdCB1ZGlkcyA9IGF3YWl0IHV0aWxpdGllcy5nZXRDb25uZWN0ZWREZXZpY2VzKCk7XG4gIGlmIChfLmlzRW1wdHkodWRpZHMpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdObyBkZXZpY2UgaXMgY29ubmVjdGVkIHRvIHRoZSBob3N0Jyk7XG4gIH1cbiAgY29uc3QgdWRpZCA9IF8ubGFzdCh1ZGlkcyk7XG4gIGlmICh1ZGlkcy5sZW5ndGggPiAxKSB7XG4gICAgbG9nLndhcm4oYE11bHRpcGxlIGRldmljZXMgZm91bmQ6ICR7dWRpZHMuam9pbignLCAnKX1gKTtcbiAgICBsb2cud2FybihgQ2hvb3NpbmcgJyR7dWRpZH0nLiBJZiB0aGlzIGlzIHdyb25nLCBtYW51YWxseSBzZXQgd2l0aCAndWRpZCcgZGVzaXJlZCBjYXBhYmlsaXR5YCk7XG4gIH1cbiAgbG9nLmRlYnVnKGBEZXRlY3RlZCByZWFsIGRldmljZSB1ZGlkOiAnJHt1ZGlkfSdgKTtcbiAgcmV0dXJuIHVkaWQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFuZENoZWNrWGNvZGVWZXJzaW9uICgpIHtcbiAgbGV0IHZlcnNpb247XG4gIHRyeSB7XG4gICAgdmVyc2lvbiA9IGF3YWl0IHhjb2RlLmdldFZlcnNpb24odHJ1ZSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5kZWJ1ZyhlcnIpO1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgZGV0ZXJtaW5lIFhjb2RlIHZlcnNpb246ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cblxuICAvLyB3ZSBkbyBub3Qgc3VwcG9ydCBYY29kZXMgPCA3LjMsXG4gIGlmICh2ZXJzaW9uLnZlcnNpb25GbG9hdCA8IDcuMykge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBYY29kZSB2ZXJzaW9uICcke3ZlcnNpb24udmVyc2lvblN0cmluZ30nLiBTdXBwb3J0IGZvciBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgWGNvZGUgJHt2ZXJzaW9uLnZlcnNpb25TdHJpbmd9IGlzIG5vdCBzdXBwb3J0ZWQuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGBQbGVhc2UgdXBncmFkZSB0byB2ZXJzaW9uIDcuMyBvciBoaWdoZXJgKTtcbiAgfVxuICByZXR1cm4gdmVyc2lvbjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QW5kQ2hlY2tJb3NTZGtWZXJzaW9uICgpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgeGNvZGUuZ2V0TWF4SU9TU0RLKCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBDb3VsZCBub3QgZGV0ZXJtaW5lIGlPUyBTREsgdmVyc2lvbjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCB0aGUgZ2VuZXJpYyBzaW11bGF0b3IgZm9yIGEgZ2l2ZW4gSU9TIHZlcnNpb24gYW5kIGRldmljZSB0eXBlIChpUGhvbmUsIGlQYWQpXG4gKlxuICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBwbGF0Zm9ybVZlcnNpb24gSU9TIHZlcnNpb24uIGUuZy4pIDEzLjBcbiAqIEBwYXJhbSB7c3RyaW5nfSBkZXZpY2VOYW1lIFR5cGUgb2YgSU9TIGRldmljZS4gQ2FuIGJlIGlQaG9uZSwgaVBhZCAocG9zc2libHkgbW9yZSBpbiB0aGUgZnV0dXJlKVxuICpcbiAqIEByZXR1cm5zIHtzdHJpbmd9IEdlbmVyaWMgaVBob25lIG9yIGlQYWQgc2ltdWxhdG9yIChpZiBhcHBsaWNhYmxlKVxuICovXG5mdW5jdGlvbiBnZXRHZW5lcmljU2ltdWxhdG9yRm9ySW9zVmVyc2lvbiAocGxhdGZvcm1WZXJzaW9uLCBkZXZpY2VOYW1lKSB7XG4gIGxldCBnZW5lcmljU2ltdWxhdG9ycyA9IGlvc0dlbmVyaWNTaW11bGF0b3JzW2RldmljZU5hbWVdO1xuXG4gIGlmIChnZW5lcmljU2ltdWxhdG9ycykge1xuICAgIGdlbmVyaWNTaW11bGF0b3JzID0gZ2VuZXJpY1NpbXVsYXRvcnMuc29ydCgoW3NpbU9uZV0sIFtzaW1Ud29dKSA9PiB1dGlsLmNvbXBhcmVWZXJzaW9ucyhzaW1PbmUsICc8Jywgc2ltVHdvKSA/IC0xIDogMSk7XG5cbiAgICAvLyBGaW5kIHRoZSBoaWdoZXN0IGlPUyB2ZXJzaW9uIGluIHRoZSBsaXN0IHRoYXQgaXMgYmVsb3cgdGhlIHByb3ZpZGVkIHZlcnNpb25cbiAgICBsZXQgZ2VuZXJpY0lvc1NpbXVsYXRvcjtcbiAgICBmb3IgKGNvbnN0IFtwbGF0Zm9ybVZlcnNpb25Gcm9tTGlzdCwgaW9zU2ltdWxhdG9yXSBvZiBnZW5lcmljU2ltdWxhdG9ycykge1xuICAgICAgaWYgKHV0aWwuY29tcGFyZVZlcnNpb25zKHBsYXRmb3JtVmVyc2lvbkZyb21MaXN0LCAnPicsIHBsYXRmb3JtVmVyc2lvbikpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBnZW5lcmljSW9zU2ltdWxhdG9yID0gaW9zU2ltdWxhdG9yO1xuICAgIH1cbiAgICByZXR1cm4gZ2VuZXJpY0lvc1NpbXVsYXRvcjtcbiAgfVxufVxuXG5mdW5jdGlvbiB0cmFuc2xhdGVEZXZpY2VOYW1lIChwbGF0Zm9ybVZlcnNpb24sIGRldmljZU5hbWUgPSAnJykge1xuICBjb25zdCBkZXZpY2VOYW1lVHJhbnNsYXRlZCA9IGdldEdlbmVyaWNTaW11bGF0b3JGb3JJb3NWZXJzaW9uKHBsYXRmb3JtVmVyc2lvbiwgZGV2aWNlTmFtZS50b0xvd2VyQ2FzZSgpLnRyaW0oKSk7XG4gIGlmIChkZXZpY2VOYW1lVHJhbnNsYXRlZCkge1xuICAgIGxvZy5kZWJ1ZyhgQ2hhbmdpbmcgZGV2aWNlTmFtZSBmcm9tICcke2RldmljZU5hbWV9JyB0byAnJHtkZXZpY2VOYW1lVHJhbnNsYXRlZH0nYCk7XG4gICAgcmV0dXJuIGRldmljZU5hbWVUcmFuc2xhdGVkO1xuICB9XG4gIHJldHVybiBkZXZpY2VOYW1lO1xufVxuXG4vLyBUaGlzIG1hcCBjb250YWlucyBkZXJpdmVkIGRhdGEgbG9ncyBmb2xkZXJzIGFzIGtleXNcbi8vIGFuZCB2YWx1ZXMgYXJlIHRoZSBjb3VudCBvZiB0aW1lcyB0aGUgcGFydGljdWxhclxuLy8gZm9sZGVyIGhhcyBiZWVuIHNjaGVkdWxlZCBmb3IgcmVtb3ZhbFxuY29uc3QgZGVyaXZlZERhdGFDbGVhbnVwTWFya2VycyA9IG5ldyBNYXAoKTtcblxuYXN5bmMgZnVuY3Rpb24gbWFya1N5c3RlbUZpbGVzRm9yQ2xlYW51cCAod2RhKSB7XG4gIGlmICghd2RhIHx8ICFhd2FpdCB3ZGEucmV0cmlldmVEZXJpdmVkRGF0YVBhdGgoKSkge1xuICAgIGxvZy53YXJuKCdObyBXZWJEcml2ZXJBZ2VudCBkZXJpdmVkIGRhdGEgYXZhaWxhYmxlLCBzbyB1bmFibGUgdG8gbWFyayBzeXN0ZW0gZmlsZXMgZm9yIGNsZWFudXAnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBsb2dzUm9vdCA9IHBhdGgucmVzb2x2ZShhd2FpdCB3ZGEucmV0cmlldmVEZXJpdmVkRGF0YVBhdGgoKSwgJ0xvZ3MnKTtcbiAgbGV0IG1hcmtlcnNDb3VudCA9IDA7XG4gIGlmIChkZXJpdmVkRGF0YUNsZWFudXBNYXJrZXJzLmhhcyhsb2dzUm9vdCkpIHtcbiAgICBtYXJrZXJzQ291bnQgPSBkZXJpdmVkRGF0YUNsZWFudXBNYXJrZXJzLmdldChsb2dzUm9vdCk7XG4gIH1cbiAgZGVyaXZlZERhdGFDbGVhbnVwTWFya2Vycy5zZXQobG9nc1Jvb3QsICsrbWFya2Vyc0NvdW50KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2xlYXJTeXN0ZW1GaWxlcyAod2RhKSB7XG4gIC8vIG9ubHkgd2FudCB0byBjbGVhciB0aGUgc3lzdGVtIGZpbGVzIGZvciB0aGUgcGFydGljdWxhciBXREEgeGNvZGUgcnVuXG4gIGlmICghd2RhIHx8ICFhd2FpdCB3ZGEucmV0cmlldmVEZXJpdmVkRGF0YVBhdGgoKSkge1xuICAgIGxvZy53YXJuKCdObyBXZWJEcml2ZXJBZ2VudCBkZXJpdmVkIGRhdGEgYXZhaWxhYmxlLCBzbyB1bmFibGUgdG8gY2xlYXIgc3lzdGVtIGZpbGVzJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgbG9nc1Jvb3QgPSBwYXRoLnJlc29sdmUoYXdhaXQgd2RhLnJldHJpZXZlRGVyaXZlZERhdGFQYXRoKCksICdMb2dzJyk7XG4gIGlmIChkZXJpdmVkRGF0YUNsZWFudXBNYXJrZXJzLmhhcyhsb2dzUm9vdCkpIHtcbiAgICBsZXQgbWFya2Vyc0NvdW50ID0gZGVyaXZlZERhdGFDbGVhbnVwTWFya2Vycy5nZXQobG9nc1Jvb3QpO1xuICAgIGRlcml2ZWREYXRhQ2xlYW51cE1hcmtlcnMuc2V0KGxvZ3NSb290LCAtLW1hcmtlcnNDb3VudCk7XG4gICAgaWYgKG1hcmtlcnNDb3VudCA+IDApIHtcbiAgICAgIGxvZy5pbmZvKGBOb3QgY2xlYW5pbmcgJyR7bG9nc1Jvb3R9JyBmb2xkZXIsIGJlY2F1c2UgdGhlIG90aGVyIHNlc3Npb24gZG9lcyBub3QgZXhwZWN0IGl0IHRvIGJlIGNsZWFuZWRgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gIH1cbiAgZGVyaXZlZERhdGFDbGVhbnVwTWFya2Vycy5zZXQobG9nc1Jvb3QsIDApO1xuXG4gIC8vIENsZWFuaW5nIHVwIGJpZyB0ZW1wb3JhcnkgZmlsZXMgY3JlYXRlZCBieSBYQ1Rlc3Q6IGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy85NDEwXG4gIGNvbnN0IGdsb2JQYXR0ZXJuID0gYCR7b3MudG1wZGlyKCl9LyR7WENURVNUX0xPR1NfQ0FDSEVfRk9MREVSX1BSRUZJWH0qL2A7XG4gIGNvbnN0IGRzdEZvbGRlcnMgPSBhd2FpdCBmcy5nbG9iKGdsb2JQYXR0ZXJuKTtcbiAgaWYgKF8uaXNFbXB0eShkc3RGb2xkZXJzKSkge1xuICAgIGxvZy5kZWJ1ZyhgRGlkIG5vdCBmaW5kIHRoZSB0ZW1wb3JhcnkgWENUZXN0IGxvZ3Mgcm9vdCBhdCAnJHtnbG9iUGF0dGVybn0nYCk7XG4gIH0gZWxzZSB7XG4gICAgLy8gcGVyZm9ybSB0aGUgY2xlYW51cCBhc3luY2hyb25vdXNseVxuICAgIGZvciAoY29uc3QgZHN0Rm9sZGVyIG9mIGRzdEZvbGRlcnMpIHtcbiAgICAgIGxldCBzY2hlZHVsZWRGaWxlc0NvdW50ID0gMDtcbiAgICAgIEIucmVzb2x2ZShmcy53YWxrRGlyKGRzdEZvbGRlciwgdHJ1ZSwgKGl0ZW1QYXRoLCBpc0RpcikgPT4ge1xuICAgICAgICBpZiAoaXNEaXIpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZmlsZU5hbWUgPSBwYXRoLmJhc2VuYW1lKGl0ZW1QYXRoKTtcbiAgICAgICAgaWYgKCFYQ1RFU1RfTE9HX0ZJTEVTX1BBVFRFUk5TLnNvbWUoKHApID0+IHAudGVzdChmaWxlTmFtZSkpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gZGVsZXRlIHRoZSBmaWxlIGFzeW5jaHJvbm91c2x5XG4gICAgICAgIGZzLnVubGluayhpdGVtUGF0aCkuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICBsb2cuaW5mbyhlLm1lc3NhZ2UpO1xuICAgICAgICB9KTtcbiAgICAgICAgc2NoZWR1bGVkRmlsZXNDb3VudCsrO1xuICAgICAgfSkpLmZpbmFsbHkoKCkgPT4ge1xuICAgICAgICBpZiAoc2NoZWR1bGVkRmlsZXNDb3VudCA+IDApIHtcbiAgICAgICAgICBsb2cuaW5mbyhgU2NoZWR1bGVkICR7c2NoZWR1bGVkRmlsZXNDb3VudH0gdGVtcG9yYXJ5IFhDVGVzdCBsb2cgYCArXG4gICAgICAgICAgICBgJHt1dGlsLnBsdXJhbGl6ZSgnZmlsZScsIHNjaGVkdWxlZEZpbGVzQ291bnQpfSBmb3IgY2xlYW51cCBpbiAnJHtkc3RGb2xkZXJ9J2ApO1xuICAgICAgICB9XG4gICAgICB9KS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICBsb2cuaW5mbyhlLm1lc3NhZ2UpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgU3RhcnRlZCBiYWNrZ3JvdW5kIFhDVGVzdCBsb2dzIGNsZWFudXAgaW4gJyR7ZHN0Rm9sZGVyc30nYCk7XG4gIH1cblxuICBpZiAoYXdhaXQgZnMuZXhpc3RzKGxvZ3NSb290KSkge1xuICAgIGxvZy5pbmZvKGBDbGVhbmluZyB0ZXN0IGxvZ3MgaW4gJyR7bG9nc1Jvb3R9JyBmb2xkZXJgKTtcbiAgICBhd2FpdCBpb3NVdGlscy5jbGVhckxvZ3MoW2xvZ3NSb290XSk7XG4gICAgcmV0dXJuO1xuICB9XG4gIGxvZy5pbmZvKGBUaGVyZSBpcyBubyAke2xvZ3NSb290fSBmb2xkZXIsIHNvIG5vdCBjbGVhbmluZyBmaWxlc2ApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja0FwcFByZXNlbnQgKGFwcCkge1xuICBsb2cuZGVidWcoYENoZWNraW5nIHdoZXRoZXIgYXBwICcke2FwcH0nIGlzIGFjdHVhbGx5IHByZXNlbnQgb24gZmlsZSBzeXN0ZW1gKTtcbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKGFwcCkpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENvdWxkIG5vdCBmaW5kIGFwcCBhdCAnJHthcHB9J2ApO1xuICB9XG4gIGxvZy5kZWJ1ZygnQXBwIGlzIHByZXNlbnQnKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RHJpdmVySW5mbyAoKSB7XG4gIGNvbnN0IHN0YXQgPSBhd2FpdCBmcy5zdGF0KHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicpKTtcbiAgY29uc3QgYnVpbHQgPSBzdGF0Lm10aW1lLmdldFRpbWUoKTtcblxuICAvLyBnZXQgdGhlIHBhY2thZ2UuanNvbiBhbmQgdGhlIHZlcnNpb24gZnJvbSBpdFxuICBjb25zdCBwa2cgPSByZXF1aXJlKF9fZmlsZW5hbWUuaW5jbHVkZXMoJ2J1aWxkL2xpYi91dGlscycpID8gJy4uLy4uL3BhY2thZ2UuanNvbicgOiAnLi4vcGFja2FnZS5qc29uJyk7XG4gIGNvbnN0IHZlcnNpb24gPSBwa2cudmVyc2lvbjtcblxuICByZXR1cm4ge1xuICAgIGJ1aWx0LFxuICAgIHZlcnNpb24sXG4gIH07XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZUNvbW1hbmRUaW1lb3V0cyAodmFsdWUpIHtcbiAgLy8gVGhlIHZhbHVlIGlzIG5vcm1hbGl6ZWQgYWxyZWFkeVxuICBpZiAodHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJykge1xuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIGxldCByZXN1bHQgPSB7fTtcbiAgLy8gVXNlIGFzIGRlZmF1bHQgdGltZW91dCBmb3IgYWxsIGNvbW1hbmRzIGlmIGEgc2luZ2xlIGludGVnZXIgdmFsdWUgaXMgcHJvdmlkZWRcbiAgaWYgKCFpc05hTih2YWx1ZSkpIHtcbiAgICByZXN1bHRbREVGQVVMVF9USU1FT1VUX0tFWV0gPSBfLnRvSW50ZWdlcih2YWx1ZSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8vIEpTT04gb2JqZWN0IGhhcyBiZWVuIHByb3ZpZGVkLiBMZXQncyBwYXJzZSBpdFxuICB0cnkge1xuICAgIHJlc3VsdCA9IEpTT04ucGFyc2UodmFsdWUpO1xuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KHJlc3VsdCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigpO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFwiY29tbWFuZFRpbWVvdXRzXCIgY2FwYWJpbGl0eSBzaG91bGQgYmUgYSB2YWxpZCBKU09OIG9iamVjdC4gXCIke3ZhbHVlfVwiIHdhcyBnaXZlbiBpbnN0ZWFkYCk7XG4gIH1cbiAgZm9yIChsZXQgW2NtZCwgdGltZW91dF0gb2YgXy50b1BhaXJzKHJlc3VsdCkpIHtcbiAgICBpZiAoIV8uaXNJbnRlZ2VyKHRpbWVvdXQpIHx8IHRpbWVvdXQgPD0gMCkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSB0aW1lb3V0IGZvciBcIiR7Y21kfVwiIHNob3VsZCBiZSBhIHZhbGlkIG5hdHVyYWwgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcy4gXCIke3RpbWVvdXR9XCIgd2FzIGdpdmVuIGluc3RlYWRgKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJpbnRVc2VyICgpIHtcbiAgdHJ5IHtcbiAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKCd3aG9hbWknKTtcbiAgICBsb2cuZGVidWcoYEN1cnJlbnQgdXNlcjogJyR7c3Rkb3V0LnRyaW0oKX0nYCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy5kZWJ1ZyhgVW5hYmxlIHRvIGdldCB1c2VybmFtZSBydW5uaW5nIHNlcnZlcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCB0aGUgSURzIG9mIHByb2Nlc3NlcyBsaXN0ZW5pbmcgb24gdGhlIHBhcnRpY3VsYXIgc3lzdGVtIHBvcnQuXG4gKiBJdCBpcyBhbHNvIHBvc3NpYmxlIHRvIGFwcGx5IGFkZGl0aW9uYWwgZmlsdGVyaW5nIGJhc2VkIG9uIHRoZVxuICogcHJvY2VzcyBjb21tYW5kIGxpbmUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBwb3J0IC0gVGhlIHBvcnQgbnVtYmVyLlxuICogQHBhcmFtIHs/RnVuY3Rpb259IGZpbHRlcmluZ0Z1bmMgLSBPcHRpb25hbCBsYW1iZGEgZnVuY3Rpb24sIHdoaWNoXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY2VpdmVzIGNvbW1hbmQgbGluZSBzdHJpbmcgb2YgdGhlIHBhcnRpY3VsYXIgcHJvY2Vzc1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5pbmcgb24gZ2l2ZW4gcG9ydCwgYW5kIGlzIGV4cGVjdGVkIHRvIHJldHVyblxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlaXRoZXIgdHJ1ZSBvciBmYWxzZSB0byBpbmNsdWRlL2V4Y2x1ZGUgdGhlIGNvcnJlc3BvbmRpbmcgUElEXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZyb20gdGhlIHJlc3VsdGluZyBhcnJheS5cbiAqIEByZXR1cm5zIHtBcnJheTxzdHJpbmc+fSAtIHRoZSBsaXN0IG9mIG1hdGNoZWQgcHJvY2VzcyBpZHMuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldFBJRHNMaXN0ZW5pbmdPblBvcnQgKHBvcnQsIGZpbHRlcmluZ0Z1bmMgPSBudWxsKSB7XG4gIGNvbnN0IHJlc3VsdCA9IFtdO1xuICB0cnkge1xuICAgIC8vIFRoaXMgb25seSB3b3JrcyBzaW5jZSBNYWMgT1MgWCBFbCBDYXBpdGFuXG4gICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKCdsc29mJywgWyctdGknLCBgdGNwOiR7cG9ydH1gXSk7XG4gICAgcmVzdWx0LnB1c2goLi4uKHN0ZG91dC50cmltKCkuc3BsaXQoL1xcbisvKSkpO1xuICB9IGNhdGNoIChlKSB7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGlmICghXy5pc0Z1bmN0aW9uKGZpbHRlcmluZ0Z1bmMpKSB7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuICByZXR1cm4gYXdhaXQgQi5maWx0ZXIocmVzdWx0LCBhc3luYyAoeCkgPT4ge1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygncHMnLCBbJy1wJywgeCwgJy1vJywgJ2NvbW1hbmQnXSk7XG4gICAgcmV0dXJuIGF3YWl0IGZpbHRlcmluZ0Z1bmMoc3Rkb3V0KTtcbiAgfSk7XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gVXBsb2FkT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdXNlciAtIFRoZSBuYW1lIG9mIHRoZSB1c2VyIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG1ldGhvZCAtIFRoZSBodHRwIG11bHRpcGFydCB1cGxvYWQgbWV0aG9kIG5hbWUuIFRoZSAnUFVUJyBvbmUgaXMgdXNlZCBieSBkZWZhdWx0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P09iamVjdH0gaGVhZGVycyAtIEFkZGl0aW9uYWwgaGVhZGVycyBtYXBwaW5nIGZvciBtdWx0aXBhcnQgaHR0cChzKSB1cGxvYWRzXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IGZpbGVGaWVsZE5hbWUgW2ZpbGVdIC0gVGhlIG5hbWUgb2YgdGhlIGZvcm0gZmllbGQsIHdoZXJlIHRoZSBmaWxlIGNvbnRlbnQgQkxPQiBzaG91bGQgYmUgc3RvcmVkIGZvclxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0dHAocykgdXBsb2Fkc1xuICogQHByb3BlcnR5IHs/T2JqZWN0fEFycmF5PFBhaXI+fSBmb3JtRmllbGRzIC0gQWRkaXRpb25hbCBmb3JtIGZpZWxkcyBmb3IgbXVsdGlwYXJ0IGh0dHAocykgdXBsb2Fkc1xuICovXG5cblxuLyoqXG4gKiBFbmNvZGVzIHRoZSBnaXZlbiBsb2NhbCBmaWxlIHRvIGJhc2U2NCBhbmQgcmV0dXJucyB0aGUgcmVzdWx0aW5nIHN0cmluZ1xuICogb3IgdXBsb2FkcyBpdCB0byBhIHJlbW90ZSBzZXJ2ZXIgdXNpbmcgaHR0cC9odHRwcyBvciBmdHAgcHJvdG9jb2xzXG4gKiBpZiBgcmVtb3RlUGF0aGAgaXMgc2V0XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGxvY2FsUGF0aCAtIFRoZSBwYXRoIHRvIGFuIGV4aXN0aW5nIGxvY2FsIGZpbGVcbiAqIEBwYXJhbSB7P3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIHRoZSByZW1vdGUgbG9jYXRpb24sIHdoZXJlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzIGZpbGUgc2hvdWxkIGJlIHVwbG9hZGVkXG4gKiBAcGFyYW0gez9VcGxvYWRPcHRpb25zfSB1cGxvYWRPcHRpb25zIC0gU2V0IG9mIHVwbG9hZCBvcHRpb25zXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBFaXRoZXIgYW4gZW1wdHkgc3RyaW5nIGlmIHRoZSB1cGxvYWQgd2FzIHN1Y2Nlc3NmdWwgb3JcbiAqIGJhc2U2NC1lbmNvZGVkIGZpbGUgcmVwcmVzZW50YXRpb24gaWYgYHJlbW90ZVBhdGhgIGlzIGZhbHN5XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGVuY29kZUJhc2U2NE9yVXBsb2FkIChsb2NhbFBhdGgsIHJlbW90ZVBhdGggPSBudWxsLCB1cGxvYWRPcHRpb25zID0ge30pIHtcbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMobG9jYWxQYXRoKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBUaGUgZmlsZSBhdCAnJHtsb2NhbFBhdGh9JyBkb2VzIG5vdCBleGlzdCBvciBpcyBub3QgYWNjZXNzaWJsZWApO1xuICB9XG5cbiAgaWYgKF8uaXNFbXB0eShyZW1vdGVQYXRoKSkge1xuICAgIGNvbnN0IHtzaXplfSA9IGF3YWl0IGZzLnN0YXQobG9jYWxQYXRoKTtcbiAgICBsb2cuZGVidWcoYFRoZSBzaXplIG9mIHRoZSBmaWxlIGlzICR7dXRpbC50b1JlYWRhYmxlU2l6ZVN0cmluZyhzaXplKX1gKTtcbiAgICByZXR1cm4gKGF3YWl0IHV0aWwudG9Jbk1lbW9yeUJhc2U2NChsb2NhbFBhdGgpKS50b1N0cmluZygpO1xuICB9XG5cbiAgY29uc3Qge3VzZXIsIHBhc3MsIG1ldGhvZCwgaGVhZGVycywgZmlsZUZpZWxkTmFtZSwgZm9ybUZpZWxkc30gPSB1cGxvYWRPcHRpb25zO1xuICBjb25zdCBvcHRpb25zID0ge1xuICAgIG1ldGhvZDogbWV0aG9kIHx8ICdQVVQnLFxuICAgIGhlYWRlcnMsXG4gICAgZmlsZUZpZWxkTmFtZSxcbiAgICBmb3JtRmllbGRzLFxuICB9O1xuICBpZiAodXNlciAmJiBwYXNzKSB7XG4gICAgb3B0aW9ucy5hdXRoID0ge3VzZXIsIHBhc3N9O1xuICB9XG4gIGF3YWl0IG5ldC51cGxvYWRGaWxlKGxvY2FsUGF0aCwgcmVtb3RlUGF0aCwgb3B0aW9ucyk7XG4gIHJldHVybiAnJztcbn1cblxuLyoqXG4gKiBTdG9wcyBhbmQgcmVtb3ZlcyBhbGwgd2ViIHNvY2tldCBoYW5kbGVycyB0aGF0IGFyZSBsaXN0ZW5pbmdcbiAqIGluIHNjb3BlIG9mIHRoZSBjdXJyZWN0IHNlc3Npb24uXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IHNlcnZlciAtIFRoZSBpbnN0YW5jZSBvZiBOb2RlSnMgSFRUUCBzZXJ2ZXIsXG4gKiB3aGljaCBob3N0cyBBcHBpdW1cbiAqIEBwYXJhbSB7c3RyaW5nfSBzZXNzaW9uSWQgLSBUaGUgaWQgb2YgdGhlIGN1cnJlbnQgc2Vzc2lvblxuICovXG5hc3luYyBmdW5jdGlvbiByZW1vdmVBbGxTZXNzaW9uV2ViU29ja2V0SGFuZGxlcnMgKHNlcnZlciwgc2Vzc2lvbklkKSB7XG4gIGlmICghc2VydmVyIHx8ICFfLmlzRnVuY3Rpb24oc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGFjdGl2ZUhhbmRsZXJzID0gYXdhaXQgc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKHNlc3Npb25JZCk7XG4gIGZvciAoY29uc3QgcGF0aG5hbWUgb2YgXy5rZXlzKGFjdGl2ZUhhbmRsZXJzKSkge1xuICAgIGF3YWl0IHNlcnZlci5yZW1vdmVXZWJTb2NrZXRIYW5kbGVyKHBhdGhuYW1lKTtcbiAgfVxufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFBsYXRmb3JtT3B0c1xuICpcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNTaW11bGF0b3IgLSBXaGV0aGVyIHRoZSBkZXN0aW5hdGlvbiBwbGF0Zm9ybSBpcyBhIFNpbXVsYXRvclxuICogQHByb3BlcnR5IHtib29sZWFufSBpc1R2T1MgLSBXaGV0aGVyIHRoZSBkZXN0aW5hdGlvbiBwbGF0Zm9ybSBpcyBhIFNpbXVsYXRvclxuICovXG5cbi8qKlxuICogVmVyaWZ5IHdoZXRoZXIgdGhlIGdpdmVuIGFwcGxpY2F0aW9uIGlzIGNvbXBhdGlibGUgdG8gdGhlXG4gKiBwbGF0Zm9ybSB3aGVyZSBpdCBpcyBnb2luZyB0byBiZSBpbnN0YWxsZWQgYW5kIHRlc3RlZC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwIC0gVGhlIGFjdHVhbCBwYXRoIHRvIHRoZSBhcHBsaWNhdGlvbiBidW5kbGVcbiAqIEBwYXJhbSB7UGxhdGZvcm1PcHRzfSBleHBlY3RlZFBsYXRmb3JtXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgYnVuZGxlIGFyY2hpdGVjdHVyZSBkb2VzIG5vdCBtYXRjaCB0aGUgZXhwZWN0ZWQgZGV2aWNlIGFyY2hpdGVjdHVyZS5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gdmVyaWZ5QXBwbGljYXRpb25QbGF0Zm9ybSAoYXBwLCBleHBlY3RlZFBsYXRmb3JtKSB7XG4gIGxvZy5kZWJ1ZygnVmVyaWZ5aW5nIGFwcGxpY2F0aW9uIHBsYXRmb3JtJyk7XG5cbiAgY29uc3QgaW5mb1BsaXN0ID0gcGF0aC5yZXNvbHZlKGFwcCwgJ0luZm8ucGxpc3QnKTtcbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMoaW5mb1BsaXN0KSkge1xuICAgIGxvZy5kZWJ1ZyhgJyR7aW5mb1BsaXN0fScgZG9lcyBub3QgZXhpc3RgKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCB7Q0ZCdW5kbGVTdXBwb3J0ZWRQbGF0Zm9ybXN9ID0gYXdhaXQgcGxpc3QucGFyc2VQbGlzdEZpbGUoaW5mb1BsaXN0KTtcbiAgbG9nLmRlYnVnKGBDRkJ1bmRsZVN1cHBvcnRlZFBsYXRmb3JtczogJHtKU09OLnN0cmluZ2lmeShDRkJ1bmRsZVN1cHBvcnRlZFBsYXRmb3Jtcyl9YCk7XG4gIGlmICghXy5pc0FycmF5KENGQnVuZGxlU3VwcG9ydGVkUGxhdGZvcm1zKSkge1xuICAgIGxvZy5kZWJ1ZyhgQ0ZCdW5kbGVTdXBwb3J0ZWRQbGF0Zm9ybXMga2V5IGRvZXMgbm90IGV4aXN0IGluICcke2luZm9QbGlzdH0nYCk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIGlzU2ltdWxhdG9yLFxuICAgIGlzVHZPUyxcbiAgfSA9IGV4cGVjdGVkUGxhdGZvcm07XG4gIGNvbnN0IHByZWZpeCA9IGlzVHZPUyA/ICdBcHBsZVRWJyA6ICdpUGhvbmUnO1xuICBjb25zdCBzdWZmaXggPSBpc1NpbXVsYXRvciA/ICdTaW11bGF0b3InIDogJ09TJztcbiAgY29uc3QgZHN0UGxhdGZvcm0gPSBgJHtwcmVmaXh9JHtzdWZmaXh9YDtcbiAgaWYgKCFDRkJ1bmRsZVN1cHBvcnRlZFBsYXRmb3Jtcy5pbmNsdWRlcyhkc3RQbGF0Zm9ybSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7aXNTaW11bGF0b3IgPyAnU2ltdWxhdG9yJyA6ICdSZWFsIGRldmljZSd9IGFyY2hpdGVjdHVyZSBpcyB1bnN1cHBvcnRlZCBieSB0aGUgJyR7YXBwfScgYXBwbGljYXRpb24uIGAgK1xuICAgICAgYE1ha2Ugc3VyZSB0aGUgY29ycmVjdCBkZXBsb3ltZW50IHRhcmdldCBoYXMgYmVlbiBzZWxlY3RlZCBmb3IgaXRzIGNvbXBpbGF0aW9uIGluIFhjb2RlLmApO1xuICB9XG59XG5cbi8qKlxuICogUmV0dXJucyB0cnVlIGlmIHRoZSB1cmxTdHJpbmcgaXMgbG9jYWxob3N0XG4gKiBAcGFyYW0gez9zdHJpbmd9IHVybFN0cmluZ1xuICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybiB0cnVlIGlmIHRoZSB1cmxTdHJpbmcgaXMgbG9jYWxob3N0XG4gKi9cbmZ1bmN0aW9uIGlzTG9jYWxIb3N0ICh1cmxTdHJpbmcpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7aG9zdG5hbWV9ID0gdXJsLnBhcnNlKHVybFN0cmluZyk7XG4gICAgcmV0dXJuIFsnbG9jYWxob3N0JywgJzEyNy4wLjAuMScsICc6OjEnLCAnOjpmZmZmOjEyNy4wLjAuMSddLmluY2x1ZGVzKGhvc3RuYW1lKTtcbiAgfSBjYXRjaCAoaWduKSB7XG4gICAgbG9nLndhcm4oYCcke3VybFN0cmluZ30nIGNhbm5vdCBiZSBwYXJzZWQgYXMgYSB2YWxpZCBVUkxgKTtcbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbi8qKlxuICogTm9ybWFsaXplcyBwbGF0Zm9ybVZlcnNpb24gdG8gYSB2YWxpZCBpT1MgdmVyc2lvbiBzdHJpbmdcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gb3JpZ2luYWxWZXJzaW9uIC0gTG9vc2UgdmVyc2lvbiBudW1iZXIsIHRoYXQgY2FuIGJlIHBhcnNlZCBieSBzZW12ZXJcbiAqIEByZXR1cm4ge3N0cmluZ30gaU9TIHZlcnNpb24gbnVtYmVyIGluIDxtYWpvcj4uPG1pbm9yPiBmb3JtYXRcbiAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGUgdmVyc2lvbiBudW1iZXIgY2Fubm90IGJlIHBhcnNlZFxuICovXG5mdW5jdGlvbiBub3JtYWxpemVQbGF0Zm9ybVZlcnNpb24gKG9yaWdpbmFsVmVyc2lvbikge1xuICBjb25zdCBub3JtYWxpemVkVmVyc2lvbiA9IHNlbXZlci5jb2VyY2Uob3JpZ2luYWxWZXJzaW9uKTtcbiAgaWYgKCFub3JtYWxpemVkVmVyc2lvbikge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHBsYXRmb3JtIHZlcnNpb24gJyR7b3JpZ2luYWxWZXJzaW9ufScgc2hvdWxkIGJlIGEgdmFsaWQgdmVyc2lvbiBudW1iZXJgKTtcbiAgfVxuICByZXR1cm4gYCR7bm9ybWFsaXplZFZlcnNpb24ubWFqb3J9LiR7bm9ybWFsaXplZFZlcnNpb24ubWlub3J9YDtcbn1cblxuXG5leHBvcnQgeyBkZXRlY3RVZGlkLCBnZXRBbmRDaGVja1hjb2RlVmVyc2lvbiwgZ2V0QW5kQ2hlY2tJb3NTZGtWZXJzaW9uLCBnZXRHZW5lcmljU2ltdWxhdG9yRm9ySW9zVmVyc2lvbixcbiAgY2hlY2tBcHBQcmVzZW50LCBnZXREcml2ZXJJbmZvLFxuICBjbGVhclN5c3RlbUZpbGVzLCB0cmFuc2xhdGVEZXZpY2VOYW1lLCBub3JtYWxpemVDb21tYW5kVGltZW91dHMsXG4gIERFRkFVTFRfVElNRU9VVF9LRVksIG1hcmtTeXN0ZW1GaWxlc0ZvckNsZWFudXAsIHByaW50VXNlcixcbiAgZ2V0UElEc0xpc3RlbmluZ09uUG9ydCwgZW5jb2RlQmFzZTY0T3JVcGxvYWQsIHJlbW92ZUFsbFNlc3Npb25XZWJTb2NrZXRIYW5kbGVycyxcbiAgdmVyaWZ5QXBwbGljYXRpb25QbGF0Zm9ybSwgaXNMb2NhbEhvc3QsIG5vcm1hbGl6ZVBsYXRmb3JtVmVyc2lvbiB9O1xuIl0sImZpbGUiOiJsaWIvdXRpbHMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
