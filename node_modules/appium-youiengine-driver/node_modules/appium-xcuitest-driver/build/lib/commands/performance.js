"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger"));

var _utils = require("../utils");

var _asyncbox = require("asyncbox");

var _os = _interopRequireDefault(require("os"));

let commands = {};
exports.commands = commands;
const PERF_RECORD_FEAT_NAME = 'perf_record';
const PERF_RECORD_SECURITY_MESSAGE = 'Performance measurement requires relaxing security for simulator. ' + `Please set '--relaxed-security' or '--allow-insecure' with '${PERF_RECORD_FEAT_NAME}' ` + 'referencing https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/security.md for more details.';
const DEFAULT_TIMEOUT_MS = 5 * 60 * 1000;
const STOP_TIMEOUT_MS = 3 * 60 * 1000;
const STARTUP_TIMEOUT_MS = 15 * 1000;
const DEFAULT_PROFILE_NAME = 'Activity Monitor';
const DEFAULT_EXT = 'trace';
const DEFAULT_PID = 'current';
const INSTRUMENTS_BINARY = 'instruments';

async function requireInstruments() {
  try {
    return await _appiumSupport.fs.which(INSTRUMENTS_BINARY);
  } catch (e) {
    _logger.default.errorAndThrow(`${INSTRUMENTS_BINARY} has not been found in PATH. ` + `Please make sure Xcode development tools are installed`);
  }
}

class PerfRecorder {
  constructor(reportPath, udid, opts = {}) {
    this._process = null;
    this._reportPath = reportPath;
    this._zippedReportPath = '';
    this._timeout = opts.timeout && opts.timeout > 0 ? opts.timeout : DEFAULT_TIMEOUT_MS;
    this._profileName = opts.profileName || DEFAULT_PROFILE_NAME;
    this._pid = opts.pid;
    this._udid = udid;
    this._logger = _appiumSupport.logger.getLogger(`${_lodash.default.truncate(this._profileName, {
      length: 10
    })}@${this._udid.substring(0, 8)}`);
    this._archivePromise = null;
  }

  get profileName() {
    return this._profileName;
  }

  async getOriginalReportPath() {
    return (await _appiumSupport.fs.exists(this._reportPath)) ? this._reportPath : '';
  }

  async getZippedReportPath() {
    if (await _appiumSupport.fs.exists(this._zippedReportPath)) {
      return this._zippedReportPath;
    }

    const originalReportPath = await this.getOriginalReportPath();

    if (!originalReportPath) {
      return '';
    }

    const zippedReportPath = originalReportPath.replace(`.${DEFAULT_EXT}`, '.zip');

    if (!this._archivePromise) {
      this._archivePromise = _appiumSupport.zip.toArchive(zippedReportPath, {
        cwd: originalReportPath
      });
    }

    await this._archivePromise;
    this._zippedReportPath = zippedReportPath;
    return this._zippedReportPath;
  }

  isRunning() {
    var _this$_process;

    return !!((_this$_process = this._process) === null || _this$_process === void 0 ? void 0 : _this$_process.isRunning);
  }

  async _enforceTermination() {
    if (this._process && this.isRunning()) {
      this._logger.debug('Force-stopping the currently running perf recording');

      try {
        await this._process.stop('SIGKILL');
      } catch (ign) {}
    }

    this._process = null;

    if (this._archivePromise) {
      this._archivePromise.then(() => _appiumSupport.fs.rimraf(this._zippedReportPath)).finally(() => {
        this._archivePromise = null;
      }).catch(() => {});
    } else {
      await _appiumSupport.fs.rimraf(this._zippedReportPath);
    }

    await _appiumSupport.fs.rimraf(this._reportPath);
    return '';
  }

  async start() {
    const instruments = await requireInstruments();
    const args = ['-w', this._udid, '-t', this._profileName, '-D', this._reportPath, '-l', `${this._timeout}`];

    if (this._pid) {
      args.push('-p', `${this._pid}`);
    }

    const fullCmd = [instruments, ...args];
    this._process = new _teen_process.SubProcess(fullCmd[0], fullCmd.slice(1));
    this._archivePromise = null;

    this._logger.debug(`Starting ${INSTRUMENTS_BINARY}: ${_appiumSupport.util.quote(fullCmd)}`);

    this._process.on('output', (stdout, stderr) => {
      if (_lodash.default.trim(stdout || stderr)) {
        this._logger.debug(`[${INSTRUMENTS_BINARY}] ${stdout || stderr}`);
      }
    });

    this._process.once('exit', async (code, signal) => {
      this._process = null;

      if (code === 0) {
        this._logger.debug('Performance recording exited without errors');

        try {
          await this.getZippedReportPath();
        } catch (e) {
          this._logger.warn(e);
        }
      } else {
        await this._enforceTermination();

        this._logger.warn(`Performance recording exited with error code ${code}, signal ${signal}`);
      }
    });

    await this._process.start(0);

    try {
      await (0, _asyncbox.waitForCondition)(async () => {
        if (await this.getOriginalReportPath()) {
          return true;
        }

        if (!this._process) {
          throw new Error(`${INSTRUMENTS_BINARY} process died unexpectedly`);
        }

        return false;
      }, {
        waitMs: STARTUP_TIMEOUT_MS,
        intervalMs: 500
      });
    } catch (e) {
      await this._enforceTermination();

      this._logger.errorAndThrow(`There is no .${DEFAULT_EXT} file found for performance profile ` + `'${this._profileName}'. Make sure the profile is supported on this device. ` + `You could use 'instruments -s' command to see the list of all available profiles. ` + `Check the server log for more details`);
    }

    this._logger.info(`The performance recording has started. Will timeout in ${this._timeout}ms`);
  }

  async stop(force = false) {
    if (force) {
      return await this._enforceTermination();
    }

    if (!this.isRunning()) {
      this._logger.debug('Performance recording is not running. Returning the recent result');

      return await this.getZippedReportPath();
    }

    try {
      await this._process.stop('SIGINT', STOP_TIMEOUT_MS);
    } catch (e) {
      this._logger.errorAndThrow(`Performance recording has failed to exit after ${STOP_TIMEOUT_MS}ms`);
    }

    return await this.getZippedReportPath();
  }

}

commands.mobileStartPerfRecord = async function mobileStartPerfRecord(opts = {}) {
  if (!this.isFeatureEnabled(PERF_RECORD_FEAT_NAME) && !this.isRealDevice()) {
    _logger.default.errorAndThrow(PERF_RECORD_SECURITY_MESSAGE);
  }

  const {
    timeout = DEFAULT_TIMEOUT_MS,
    profileName = DEFAULT_PROFILE_NAME,
    pid
  } = opts;

  if (!_lodash.default.isEmpty(this._perfRecorders)) {
    const recorders = this._perfRecorders.filter(x => x.profileName === profileName);

    if (!_lodash.default.isEmpty(recorders)) {
      for (const recorder of recorders) {
        if (recorder.isRunning()) {
          _logger.default.debug(`Performance recorder for '${profileName}' on device '${this.opts.device.udid}' ` + ` is already running. Doing nothing`);

          return;
        }

        _lodash.default.pull(this._perfRecorders, recorder);

        await recorder.stop(true);
      }
    }
  }

  const reportPath = _path.default.resolve(_os.default.tmpdir(), `appium_perf_${profileName.replace(/\W/g, '_')}_${_appiumSupport.util.uuidV4().substring(0, 8)}.${DEFAULT_EXT}`);

  let realPid;

  if (pid) {
    if (_lodash.default.toLower(pid) === DEFAULT_PID) {
      const appInfo = await this.proxyCommand('/wda/activeAppInfo', 'GET');
      realPid = appInfo.pid;
    } else {
      realPid = pid;
    }
  }

  const recorder = new PerfRecorder(reportPath, this.opts.device.udid, {
    timeout: parseInt(timeout, 10),
    profileName,
    pid: parseInt(realPid, 10)
  });
  await recorder.start();
  this._perfRecorders = [...(this._perfRecorders || []), recorder];
};

commands.mobileStopPerfRecord = async function mobileStopPerfRecord(opts = {}) {
  if (!this.isFeatureEnabled(PERF_RECORD_FEAT_NAME) && !this.isRealDevice()) {
    _logger.default.errorAndThrow(PERF_RECORD_SECURITY_MESSAGE);
  }

  if (_lodash.default.isEmpty(this._perfRecorders)) {
    _logger.default.info('No performance recorders have been started. Doing nothing');

    return '';
  }

  const {
    profileName = DEFAULT_PROFILE_NAME
  } = opts;

  const recorders = this._perfRecorders.filter(x => x.profileName === profileName);

  if (_lodash.default.isEmpty(recorders)) {
    _logger.default.errorAndThrow(`There are no records for performance profile '${profileName}' ` + `and device ${this.opts.device.udid}. Have you started the profiling before?`);
  }

  const resultPath = await recorders[0].stop();

  if (!(await _appiumSupport.fs.exists(resultPath))) {
    _logger.default.errorAndThrow(`There is no .${DEFAULT_EXT} file found for performance profile '${profileName}' ` + `and device ${this.opts.device.udid}. Make sure the profile is supported on this device. ` + `You could use 'instruments -s' command to see the list of all available profiles.`);
  }

  return await (0, _utils.encodeBase64OrUpload)(resultPath, opts.remotePath, opts);
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9wZXJmb3JtYW5jZS5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsIlBFUkZfUkVDT1JEX0ZFQVRfTkFNRSIsIlBFUkZfUkVDT1JEX1NFQ1VSSVRZX01FU1NBR0UiLCJERUZBVUxUX1RJTUVPVVRfTVMiLCJTVE9QX1RJTUVPVVRfTVMiLCJTVEFSVFVQX1RJTUVPVVRfTVMiLCJERUZBVUxUX1BST0ZJTEVfTkFNRSIsIkRFRkFVTFRfRVhUIiwiREVGQVVMVF9QSUQiLCJJTlNUUlVNRU5UU19CSU5BUlkiLCJyZXF1aXJlSW5zdHJ1bWVudHMiLCJmcyIsIndoaWNoIiwiZSIsImxvZyIsImVycm9yQW5kVGhyb3ciLCJQZXJmUmVjb3JkZXIiLCJjb25zdHJ1Y3RvciIsInJlcG9ydFBhdGgiLCJ1ZGlkIiwib3B0cyIsIl9wcm9jZXNzIiwiX3JlcG9ydFBhdGgiLCJfemlwcGVkUmVwb3J0UGF0aCIsIl90aW1lb3V0IiwidGltZW91dCIsIl9wcm9maWxlTmFtZSIsInByb2ZpbGVOYW1lIiwiX3BpZCIsInBpZCIsIl91ZGlkIiwiX2xvZ2dlciIsImxvZ2dlciIsImdldExvZ2dlciIsIl8iLCJ0cnVuY2F0ZSIsImxlbmd0aCIsInN1YnN0cmluZyIsIl9hcmNoaXZlUHJvbWlzZSIsImdldE9yaWdpbmFsUmVwb3J0UGF0aCIsImV4aXN0cyIsImdldFppcHBlZFJlcG9ydFBhdGgiLCJvcmlnaW5hbFJlcG9ydFBhdGgiLCJ6aXBwZWRSZXBvcnRQYXRoIiwicmVwbGFjZSIsInppcCIsInRvQXJjaGl2ZSIsImN3ZCIsImlzUnVubmluZyIsIl9lbmZvcmNlVGVybWluYXRpb24iLCJkZWJ1ZyIsInN0b3AiLCJpZ24iLCJ0aGVuIiwicmltcmFmIiwiZmluYWxseSIsImNhdGNoIiwic3RhcnQiLCJpbnN0cnVtZW50cyIsImFyZ3MiLCJwdXNoIiwiZnVsbENtZCIsIlN1YlByb2Nlc3MiLCJzbGljZSIsInV0aWwiLCJxdW90ZSIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwidHJpbSIsIm9uY2UiLCJjb2RlIiwic2lnbmFsIiwid2FybiIsIkVycm9yIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImluZm8iLCJmb3JjZSIsIm1vYmlsZVN0YXJ0UGVyZlJlY29yZCIsImlzRmVhdHVyZUVuYWJsZWQiLCJpc1JlYWxEZXZpY2UiLCJpc0VtcHR5IiwiX3BlcmZSZWNvcmRlcnMiLCJyZWNvcmRlcnMiLCJmaWx0ZXIiLCJ4IiwicmVjb3JkZXIiLCJkZXZpY2UiLCJwdWxsIiwicGF0aCIsInJlc29sdmUiLCJvcyIsInRtcGRpciIsInV1aWRWNCIsInJlYWxQaWQiLCJ0b0xvd2VyIiwiYXBwSW5mbyIsInByb3h5Q29tbWFuZCIsInBhcnNlSW50IiwibW9iaWxlU3RvcFBlcmZSZWNvcmQiLCJyZXN1bHRQYXRoIiwicmVtb3RlUGF0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjs7QUFFQSxNQUFNQyxxQkFBcUIsR0FBRyxhQUE5QjtBQUNBLE1BQU1DLDRCQUE0QixHQUFHLHVFQUNsQywrREFBOERELHFCQUFzQixJQURsRCxHQUVuQyx1SEFGRjtBQUdBLE1BQU1FLGtCQUFrQixHQUFHLElBQUksRUFBSixHQUFTLElBQXBDO0FBQ0EsTUFBTUMsZUFBZSxHQUFHLElBQUksRUFBSixHQUFTLElBQWpDO0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsS0FBSyxJQUFoQztBQUNBLE1BQU1DLG9CQUFvQixHQUFHLGtCQUE3QjtBQUNBLE1BQU1DLFdBQVcsR0FBRyxPQUFwQjtBQUNBLE1BQU1DLFdBQVcsR0FBRyxTQUFwQjtBQUNBLE1BQU1DLGtCQUFrQixHQUFHLGFBQTNCOztBQUdBLGVBQWVDLGtCQUFmLEdBQXFDO0FBQ25DLE1BQUk7QUFDRixXQUFPLE1BQU1DLGtCQUFHQyxLQUFILENBQVNILGtCQUFULENBQWI7QUFDRCxHQUZELENBRUUsT0FBT0ksQ0FBUCxFQUFV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QUdyQjtBQURWLE1BRUZjLElBRko7O0FBSUEsUUFBTWdFLFNBQVMsR0FBRyxLQUFLRCxjQUFMLENBQ2ZFLE1BRGUsQ0FDUEMsQ0FBRCxJQUFPQSxDQUFDLENBQUMzRCxXQUFGLEtBQWtCQSxXQURqQixDQUFsQjs7QUFFQSxNQUFJTyxnQkFBRWdELE9BQUYsQ0FBVUUsU0FBVixDQUFKLEVBQTBCO0FBQ3hCdEUsb0JBQUlDLGFBQUosQ0FBbUIsaURBQWdEWSxXQUFZLElBQTdELEdBQ2YsY0FBYSxLQUFLUCxJQUFMLENBQVVvRSxNQUFWLENBQWlCckUsSUFBSywwQ0FEdEM7QUFFRDs7QUFDRCxRQUFNa0YsVUFBVSxHQUFHLE1BQU1qQixTQUFTLENBQUMsQ0FBRCxDQUFULENBQWFqQyxJQUFiLEVBQXpCOztBQUNBLE1BQUksRUFBQyxNQUFNeEMsa0JBQUc2QixNQUFILENBQVU2RCxVQUFWLENBQVAsQ0FBSixFQUFrQztBQUNoQ3ZGLG9CQUFJQyxhQUFKLENBQW1CLGdCQUFlUixXQUFZLHdDQUF1Q29CLFdBQVksSUFBL0UsR0FDZixjQUFhLEtBQUtQLElBQUwsQ0FBVW9FLE1BQVYsQ0FBaUJyRSxJQUFLLHVEQURwQixHQUVmLG1GQUZIO0FBR0Q7O0FBRUQsU0FBTyxNQUFNLGlDQUFxQmtGLFVBQXJCLEVBQWlDakYsSUFBSSxDQUFDa0YsVUFBdEMsRUFBa0RsRixJQUFsRCxDQUFiO0FBQ0QsQ0E1QkQ7O2VBZ0NlcEIsUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCB6aXAsIGxvZ2dlciwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IFN1YlByb2Nlc3MgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZW5jb2RlQmFzZTY0T3JVcGxvYWQgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IG9zIGZyb20gJ29zJztcblxuXG5sZXQgY29tbWFuZHMgPSB7fTtcblxuY29uc3QgUEVSRl9SRUNPUkRfRkVBVF9OQU1FID0gJ3BlcmZfcmVjb3JkJztcbmNvbnN0IFBFUkZfUkVDT1JEX1NFQ1VSSVRZX01FU1NBR0UgPSAnUGVyZm9ybWFuY2UgbWVhc3VyZW1lbnQgcmVxdWlyZXMgcmVsYXhpbmcgc2VjdXJpdHkgZm9yIHNpbXVsYXRvci4gJyArXG4gIGBQbGVhc2Ugc2V0ICctLXJlbGF4ZWQtc2VjdXJpdHknIG9yICctLWFsbG93LWluc2VjdXJlJyB3aXRoICcke1BFUkZfUkVDT1JEX0ZFQVRfTkFNRX0nIGAgK1xuICAncmVmZXJlbmNpbmcgaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0vYmxvYi9tYXN0ZXIvZG9jcy9lbi93cml0aW5nLXJ1bm5pbmctYXBwaXVtL3NlY3VyaXR5Lm1kIGZvciBtb3JlIGRldGFpbHMuJztcbmNvbnN0IERFRkFVTFRfVElNRU9VVF9NUyA9IDUgKiA2MCAqIDEwMDA7XG5jb25zdCBTVE9QX1RJTUVPVVRfTVMgPSAzICogNjAgKiAxMDAwO1xuY29uc3QgU1RBUlRVUF9USU1FT1VUX01TID0gMTUgKiAxMDAwO1xuY29uc3QgREVGQVVMVF9QUk9GSUxFX05BTUUgPSAnQWN0aXZpdHkgTW9uaXRvcic7XG5jb25zdCBERUZBVUxUX0VYVCA9ICd0cmFjZSc7XG5jb25zdCBERUZBVUxUX1BJRCA9ICdjdXJyZW50JztcbmNvbnN0IElOU1RSVU1FTlRTX0JJTkFSWSA9ICdpbnN0cnVtZW50cyc7XG5cblxuYXN5bmMgZnVuY3Rpb24gcmVxdWlyZUluc3RydW1lbnRzICgpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgZnMud2hpY2goSU5TVFJVTUVOVFNfQklOQVJZKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGAke0lOU1RSVU1FTlRTX0JJTkFSWX0gaGFzIG5vdCBiZWVuIGZvdW5kIGluIFBBVEguIGAgK1xuICAgICAgYFBsZWFzZSBtYWtlIHN1cmUgWGNvZGUgZGV2ZWxvcG1lbnQgdG9vbHMgYXJlIGluc3RhbGxlZGApO1xuICB9XG59XG5cblxuY2xhc3MgUGVyZlJlY29yZGVyIHtcbiAgY29uc3RydWN0b3IgKHJlcG9ydFBhdGgsIHVkaWQsIG9wdHMgPSB7fSkge1xuICAgIHRoaXMuX3Byb2Nlc3MgPSBudWxsO1xuICAgIHRoaXMuX3JlcG9ydFBhdGggPSByZXBvcnRQYXRoO1xuICAgIHRoaXMuX3ppcHBlZFJlcG9ydFBhdGggPSAnJztcbiAgICB0aGlzLl90aW1lb3V0ID0gKG9wdHMudGltZW91dCAmJiBvcHRzLnRpbWVvdXQgPiAwKSA/IG9wdHMudGltZW91dCA6IERFRkFVTFRfVElNRU9VVF9NUztcbiAgICB0aGlzLl9wcm9maWxlTmFtZSA9IG9wdHMucHJvZmlsZU5hbWUgfHwgREVGQVVMVF9QUk9GSUxFX05BTUU7XG4gICAgdGhpcy5fcGlkID0gb3B0cy5waWQ7XG4gICAgdGhpcy5fdWRpZCA9IHVkaWQ7XG4gICAgdGhpcy5fbG9nZ2VyID0gbG9nZ2VyLmdldExvZ2dlcihcbiAgICAgIGAke18udHJ1bmNhdGUodGhpcy5fcHJvZmlsZU5hbWUsIHtsZW5ndGg6IDEwfSl9QCR7dGhpcy5fdWRpZC5zdWJzdHJpbmcoMCwgOCl9YCk7XG4gICAgdGhpcy5fYXJjaGl2ZVByb21pc2UgPSBudWxsO1xuICB9XG5cbiAgZ2V0IHByb2ZpbGVOYW1lICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcHJvZmlsZU5hbWU7XG4gIH1cblxuICBhc3luYyBnZXRPcmlnaW5hbFJlcG9ydFBhdGggKCkge1xuICAgIHJldHVybiAoYXdhaXQgZnMuZXhpc3RzKHRoaXMuX3JlcG9ydFBhdGgpKSA/IHRoaXMuX3JlcG9ydFBhdGggOiAnJztcbiAgfVxuXG4gIGFzeW5jIGdldFppcHBlZFJlcG9ydFBhdGggKCkge1xuICAgIGlmIChhd2FpdCBmcy5leGlzdHModGhpcy5femlwcGVkUmVwb3J0UGF0aCkpIHtcbiAgICAgIHJldHVybiB0aGlzLl96aXBwZWRSZXBvcnRQYXRoO1xuICAgIH1cbiAgICBjb25zdCBvcmlnaW5hbFJlcG9ydFBhdGggPSBhd2FpdCB0aGlzLmdldE9yaWdpbmFsUmVwb3J0UGF0aCgpO1xuICAgIGlmICghb3JpZ2luYWxSZXBvcnRQYXRoKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuICAgIGNvbnN0IHppcHBlZFJlcG9ydFBhdGggPSBvcmlnaW5hbFJlcG9ydFBhdGgucmVwbGFjZShgLiR7REVGQVVMVF9FWFR9YCwgJy56aXAnKTtcbiAgICAvLyBUaGlzIGlzIHRvIHByZXZlbnQgcG9zc2libGUgcmFjZSBjb25kaXRpb25zLCBiZWNhdXNlIHRoZSBhcmNoaXZlIG9wZXJhdGlvblxuICAgIC8vIGNvdWxkIGJlIHByZXR0eSB0aW1lLWludGVuc2l2ZVxuICAgIGlmICghdGhpcy5fYXJjaGl2ZVByb21pc2UpIHtcbiAgICAgIHRoaXMuX2FyY2hpdmVQcm9taXNlID0gemlwLnRvQXJjaGl2ZSh6aXBwZWRSZXBvcnRQYXRoLCB7XG4gICAgICAgIGN3ZDogb3JpZ2luYWxSZXBvcnRQYXRoLFxuICAgICAgfSk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuX2FyY2hpdmVQcm9taXNlO1xuICAgIHRoaXMuX3ppcHBlZFJlcG9ydFBhdGggPSB6aXBwZWRSZXBvcnRQYXRoO1xuICAgIHJldHVybiB0aGlzLl96aXBwZWRSZXBvcnRQYXRoO1xuICB9XG5cbiAgaXNSdW5uaW5nICgpIHtcbiAgICByZXR1cm4gISEodGhpcy5fcHJvY2Vzcz8uaXNSdW5uaW5nKTtcbiAgfVxuXG4gIGFzeW5jIF9lbmZvcmNlVGVybWluYXRpb24gKCkge1xuICAgIGlmICh0aGlzLl9wcm9jZXNzICYmIHRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZygnRm9yY2Utc3RvcHBpbmcgdGhlIGN1cnJlbnRseSBydW5uaW5nIHBlcmYgcmVjb3JkaW5nJyk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLl9wcm9jZXNzLnN0b3AoJ1NJR0tJTEwnKTtcbiAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICB9XG4gICAgdGhpcy5fcHJvY2VzcyA9IG51bGw7XG4gICAgaWYgKHRoaXMuX2FyY2hpdmVQcm9taXNlKSB7XG4gICAgICB0aGlzLl9hcmNoaXZlUHJvbWlzZVxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tdGhlblxuICAgICAgICAudGhlbigoKSA9PiBmcy5yaW1yYWYodGhpcy5femlwcGVkUmVwb3J0UGF0aCkpXG4gICAgICAgIC5maW5hbGx5KCgpID0+IHtcbiAgICAgICAgICB0aGlzLl9hcmNoaXZlUHJvbWlzZSA9IG51bGw7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoKSA9PiB7fSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IGZzLnJpbXJhZih0aGlzLl96aXBwZWRSZXBvcnRQYXRoKTtcbiAgICB9XG4gICAgYXdhaXQgZnMucmltcmFmKHRoaXMuX3JlcG9ydFBhdGgpO1xuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0ICgpIHtcbiAgICBjb25zdCBpbnN0cnVtZW50cyA9IGF3YWl0IHJlcXVpcmVJbnN0cnVtZW50cygpO1xuXG4gICAgLy8gaHR0cHM6Ly9oZWxwLmFwcGxlLmNvbS9pbnN0cnVtZW50cy9tYWMvY3VycmVudC8jL2RldmIxNGZmYWE1XG4gICAgY29uc3QgYXJncyA9IFtcbiAgICAgICctdycsIHRoaXMuX3VkaWQsXG4gICAgICAnLXQnLCB0aGlzLl9wcm9maWxlTmFtZSxcbiAgICAgICctRCcsIHRoaXMuX3JlcG9ydFBhdGgsXG4gICAgICAnLWwnLCBgJHt0aGlzLl90aW1lb3V0fWAsXG4gICAgXTtcbiAgICBpZiAodGhpcy5fcGlkKSB7XG4gICAgICBhcmdzLnB1c2goJy1wJywgYCR7dGhpcy5fcGlkfWApO1xuICAgIH1cbiAgICBjb25zdCBmdWxsQ21kID0gW1xuICAgICAgaW5zdHJ1bWVudHMsXG4gICAgICAuLi5hcmdzLFxuICAgIF07XG4gICAgdGhpcy5fcHJvY2VzcyA9IG5ldyBTdWJQcm9jZXNzKGZ1bGxDbWRbMF0sIGZ1bGxDbWQuc2xpY2UoMSkpO1xuICAgIHRoaXMuX2FyY2hpdmVQcm9taXNlID0gbnVsbDtcbiAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFN0YXJ0aW5nICR7SU5TVFJVTUVOVFNfQklOQVJZfTogJHt1dGlsLnF1b3RlKGZ1bGxDbWQpfWApO1xuICAgIHRoaXMuX3Byb2Nlc3Mub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgaWYgKF8udHJpbShzdGRvdXQgfHwgc3RkZXJyKSkge1xuICAgICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFske0lOU1RSVU1FTlRTX0JJTkFSWX1dICR7c3Rkb3V0IHx8IHN0ZGVycn1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLl9wcm9jZXNzLm9uY2UoJ2V4aXQnLCBhc3luYyAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICB0aGlzLl9wcm9jZXNzID0gbnVsbDtcbiAgICAgIGlmIChjb2RlID09PSAwKSB7XG4gICAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZygnUGVyZm9ybWFuY2UgcmVjb3JkaW5nIGV4aXRlZCB3aXRob3V0IGVycm9ycycpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIC8vIGNhY2hlIHppcHBlZCByZXBvcnRcbiAgICAgICAgICBhd2FpdCB0aGlzLmdldFppcHBlZFJlcG9ydFBhdGgoKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci53YXJuKGUpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhd2FpdCB0aGlzLl9lbmZvcmNlVGVybWluYXRpb24oKTtcbiAgICAgICAgdGhpcy5fbG9nZ2VyLndhcm4oYFBlcmZvcm1hbmNlIHJlY29yZGluZyBleGl0ZWQgd2l0aCBlcnJvciBjb2RlICR7Y29kZX0sIHNpZ25hbCAke3NpZ25hbH1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBhd2FpdCB0aGlzLl9wcm9jZXNzLnN0YXJ0KDApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgaWYgKGF3YWl0IHRoaXMuZ2V0T3JpZ2luYWxSZXBvcnRQYXRoKCkpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuX3Byb2Nlc3MpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7SU5TVFJVTUVOVFNfQklOQVJZfSBwcm9jZXNzIGRpZWQgdW5leHBlY3RlZGx5YCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSwge1xuICAgICAgICB3YWl0TXM6IFNUQVJUVVBfVElNRU9VVF9NUyxcbiAgICAgICAgaW50ZXJ2YWxNczogNTAwLFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgYXdhaXQgdGhpcy5fZW5mb3JjZVRlcm1pbmF0aW9uKCk7XG4gICAgICB0aGlzLl9sb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGhlcmUgaXMgbm8gLiR7REVGQVVMVF9FWFR9IGZpbGUgZm91bmQgZm9yIHBlcmZvcm1hbmNlIHByb2ZpbGUgYCArXG4gICAgICAgIGAnJHt0aGlzLl9wcm9maWxlTmFtZX0nLiBNYWtlIHN1cmUgdGhlIHByb2ZpbGUgaXMgc3VwcG9ydGVkIG9uIHRoaXMgZGV2aWNlLiBgICtcbiAgICAgICAgYFlvdSBjb3VsZCB1c2UgJ2luc3RydW1lbnRzIC1zJyBjb21tYW5kIHRvIHNlZSB0aGUgbGlzdCBvZiBhbGwgYXZhaWxhYmxlIHByb2ZpbGVzLiBgICtcbiAgICAgICAgYENoZWNrIHRoZSBzZXJ2ZXIgbG9nIGZvciBtb3JlIGRldGFpbHNgKTtcbiAgICB9XG4gICAgdGhpcy5fbG9nZ2VyLmluZm8oYFRoZSBwZXJmb3JtYW5jZSByZWNvcmRpbmcgaGFzIHN0YXJ0ZWQuIFdpbGwgdGltZW91dCBpbiAke3RoaXMuX3RpbWVvdXR9bXNgKTtcbiAgfVxuXG4gIGFzeW5jIHN0b3AgKGZvcmNlID0gZmFsc2UpIHtcbiAgICBpZiAoZm9yY2UpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9lbmZvcmNlVGVybWluYXRpb24oKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaXNSdW5uaW5nKCkpIHtcbiAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZygnUGVyZm9ybWFuY2UgcmVjb3JkaW5nIGlzIG5vdCBydW5uaW5nLiBSZXR1cm5pbmcgdGhlIHJlY2VudCByZXN1bHQnKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFppcHBlZFJlcG9ydFBhdGgoKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5fcHJvY2Vzcy5zdG9wKCdTSUdJTlQnLCBTVE9QX1RJTUVPVVRfTVMpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMuX2xvZ2dlci5lcnJvckFuZFRocm93KGBQZXJmb3JtYW5jZSByZWNvcmRpbmcgaGFzIGZhaWxlZCB0byBleGl0IGFmdGVyICR7U1RPUF9USU1FT1VUX01TfW1zYCk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFppcHBlZFJlcG9ydFBhdGgoKTtcbiAgfVxufVxuXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gU3RhcnRQZXJmUmVjb3JkT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P251bWJlcnxzdHJpbmd9IHRpbWVvdXQgWzMwMDAwMF0gLSBUaGUgbWF4aW11bSBjb3VudCBvZiBtaWxsaXNlY29uZHMgdG8gcmVjb3JkIHRoZSBwcm9maWxpbmcgaW5mb3JtYXRpb24uXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHByb2ZpbGVOYW1lIFtBY3Rpdml0eSBNb25pdG9yXSAtIFRoZSBuYW1lIG9mIGV4aXN0aW5nIHBlcmZvcm1hbmNlIHByb2ZpbGUgdG8gYXBwbHkuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEV4ZWN1dGUgYGluc3RydW1lbnRzIC1zYCB0byBzaG93IHRoZSBsaXN0IG9mIGF2YWlsYWJsZSBwcm9maWxlcy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2FuIGFsc28gY29udGFpbiB0aGUgZnVsbCBwYXRoIHRvIHRoZSBjaG9zZW4gdGVtcGxhdGUgb24gdGhlIHNlcnZlciBmaWxlIHN5c3RlbS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTm90ZSwgdGhhdCBub3QgYWxsIHByb2ZpbGVzIGFyZSBzdXBwb3J0ZWQgb24gbW9iaWxlIGRldmljZXMuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd8bnVtYmVyfSBwaWQgLSBUaGUgSUQgb2YgdGhlIHByb2Nlc3MgdG8gbWVhc3VyZSB0aGUgcGVyZm9ybWFuY2UgZm9yLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2V0IGl0IHRvIGBjdXJyZW50YCBpbiBvcmRlciB0byBtZWFzdXJlIHRoZSBwZXJmb3JtYW5jZSBvZlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIHByb2Nlc3MsIHdoaWNoIGJlbG9uZ3MgdG8gdGhlIGN1cnJlbnRseSBhY3RpdmUgYXBwbGljYXRpb24uXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBbGwgcHJvY2Vzc2VzIHJ1bm5pbmcgb24gdGhlIGRldmljZSBhcmUgbWVhc3VyZWQgaWZcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZCBpcyB1bnNldCAodGhlIGRlZmF1bHQgc2V0dGluZykuXG4gKi9cblxuLyoqXG4gKiBTdGFydHMgcGVyZm9ybWFuY2UgcHJvZmlsaW5nIGZvciB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiBSZWxheGluZyBzZWN1cml0eSBpcyBtYW5kYXRvcnkgZm9yIHNpbXVsYXRvcnMuIEl0IGNhbiBhbHdheXMgd29yayBmb3IgcmVhbCBkZXZpY2VzLlxuICpcbiAqIFRoZSBgaW5zdHJ1bWVudHNgIGRldmVsb3BlciB1dGlsaXR5IGlzIHVzZWQgZm9yIHRoaXMgcHVycG9zZSB1bmRlciB0aGUgaG9vZC5cbiAqIEl0IGlzIHBvc3NpYmxlIHRvIHJlY29yZCBtdWx0aXBsZSBwcm9maWxlcyBhdCB0aGUgc2FtZSB0aW1lLlxuICogUmVhZCBodHRwczovL2RldmVsb3Blci5hcHBsZS5jb20vbGlicmFyeS9jb250ZW50L2RvY3VtZW50YXRpb24vRGV2ZWxvcGVyVG9vbHMvQ29uY2VwdHVhbC9JbnN0cnVtZW50c1VzZXJHdWlkZS9SZWNvcmRpbmcsUGF1c2luZyxhbmRTdG9wcGluZ1RyYWNlcy5odG1sXG4gKiBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIEBwYXJhbSB7P1N0YXJ0UGVyZlJlY29yZE9wdGlvbnN9IG9wdHMgLSBUaGUgc2V0IG9mIHBvc3NpYmxlIHN0YXJ0IHJlY29yZCBvcHRpb25zXG4gKi9cbmNvbW1hbmRzLm1vYmlsZVN0YXJ0UGVyZlJlY29yZCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVN0YXJ0UGVyZlJlY29yZCAob3B0cyA9IHt9KSB7XG4gIGlmICghdGhpcy5pc0ZlYXR1cmVFbmFibGVkKFBFUkZfUkVDT1JEX0ZFQVRfTkFNRSkgJiYgIXRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhQRVJGX1JFQ09SRF9TRUNVUklUWV9NRVNTQUdFKTtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICB0aW1lb3V0ID0gREVGQVVMVF9USU1FT1VUX01TLFxuICAgIHByb2ZpbGVOYW1lID0gREVGQVVMVF9QUk9GSUxFX05BTUUsXG4gICAgcGlkLFxuICB9ID0gb3B0cztcblxuICBpZiAoIV8uaXNFbXB0eSh0aGlzLl9wZXJmUmVjb3JkZXJzKSkge1xuICAgIGNvbnN0IHJlY29yZGVycyA9IHRoaXMuX3BlcmZSZWNvcmRlcnNcbiAgICAgIC5maWx0ZXIoKHgpID0+IHgucHJvZmlsZU5hbWUgPT09IHByb2ZpbGVOYW1lKTtcbiAgICBpZiAoIV8uaXNFbXB0eShyZWNvcmRlcnMpKSB7XG4gICAgICBmb3IgKGNvbnN0IHJlY29yZGVyIG9mIHJlY29yZGVycykge1xuICAgICAgICBpZiAocmVjb3JkZXIuaXNSdW5uaW5nKCkpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYFBlcmZvcm1hbmNlIHJlY29yZGVyIGZvciAnJHtwcm9maWxlTmFtZX0nIG9uIGRldmljZSAnJHt0aGlzLm9wdHMuZGV2aWNlLnVkaWR9JyBgICtcbiAgICAgICAgICAgIGAgaXMgYWxyZWFkeSBydW5uaW5nLiBEb2luZyBub3RoaW5nYCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIF8ucHVsbCh0aGlzLl9wZXJmUmVjb3JkZXJzLCByZWNvcmRlcik7XG4gICAgICAgIGF3YWl0IHJlY29yZGVyLnN0b3AodHJ1ZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY29uc3QgcmVwb3J0UGF0aCA9IHBhdGgucmVzb2x2ZShvcy50bXBkaXIoKSxcbiAgICBgYXBwaXVtX3BlcmZfJHtwcm9maWxlTmFtZS5yZXBsYWNlKC9cXFcvZywgJ18nKX1fJHt1dGlsLnV1aWRWNCgpLnN1YnN0cmluZygwLCA4KX0uJHtERUZBVUxUX0VYVH1gKTtcbiAgbGV0IHJlYWxQaWQ7XG4gIGlmIChwaWQpIHtcbiAgICBpZiAoXy50b0xvd2VyKHBpZCkgPT09IERFRkFVTFRfUElEKSB7XG4gICAgICBjb25zdCBhcHBJbmZvID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy93ZGEvYWN0aXZlQXBwSW5mbycsICdHRVQnKTtcbiAgICAgIHJlYWxQaWQgPSBhcHBJbmZvLnBpZDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVhbFBpZCA9IHBpZDtcbiAgICB9XG4gIH1cbiAgY29uc3QgcmVjb3JkZXIgPSBuZXcgUGVyZlJlY29yZGVyKHJlcG9ydFBhdGgsIHRoaXMub3B0cy5kZXZpY2UudWRpZCwge1xuICAgIHRpbWVvdXQ6IHBhcnNlSW50KHRpbWVvdXQsIDEwKSxcbiAgICBwcm9maWxlTmFtZSxcbiAgICBwaWQ6IHBhcnNlSW50KHJlYWxQaWQsIDEwKSxcbiAgfSk7XG4gIGF3YWl0IHJlY29yZGVyLnN0YXJ0KCk7XG4gIHRoaXMuX3BlcmZSZWNvcmRlcnMgPSBbLi4uKHRoaXMuX3BlcmZSZWNvcmRlcnMgfHwgW10pLCByZWNvcmRlcl07XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0b3BSZWNvcmRpbmdPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHBhdGggdG8gdGhlIHJlbW90ZSBsb2NhdGlvbiwgd2hlcmUgdGhlIHJlc3VsdGluZyB6aXBwZWQgLnRyYWNlIGZpbGUgc2hvdWxkIGJlIHVwbG9hZGVkLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGZvbGxvd2luZyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZDogaHR0cC9odHRwcywgZnRwLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTnVsbCBvciBlbXB0eSBzdHJpbmcgdmFsdWUgKHRoZSBkZWZhdWx0IHNldHRpbmcpIG1lYW5zIHRoZSBjb250ZW50IG9mIHJlc3VsdGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSBzaG91bGQgYmUgemlwcGVkLCBlbmNvZGVkIGFzIEJhc2U2NCBhbmQgcGFzc2VkIGFzIHRoZSBlbmRwb2ludCByZXNwb25zZSB2YWx1ZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpZiB0aGUgZ2VuZXJhdGVkIGZpbGUgaXMgdG9vIGJpZyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZml0IGludG8gdGhlIGF2YWlsYWJsZSBwcm9jZXNzIG1lbW9yeS5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gdXNlciAtIFRoZSBuYW1lIG9mIHRoZSB1c2VyIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi4gT25seSB3b3JrcyBpZiBgcmVtb3RlUGF0aGAgaXMgcHJvdmlkZWQuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IG1ldGhvZCBbUFVUXSAtIFRoZSBodHRwIG11bHRpcGFydCB1cGxvYWQgbWV0aG9kIG5hbWUuIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBwcm9maWxlTmFtZSBbQWN0aXZpdHkgTW9uaXRvcl0gLSBUaGUgbmFtZSBvZiBhbiBleGlzdGluZyBwZXJmb3JtYW5jZSBwcm9maWxlIGZvciB3aGljaCB0aGUgcmVjb3JkaW5nIGhhcyBiZWVuIG1hZGUuXG4gKiBAcHJvcGVydHkgez9PYmplY3R9IGhlYWRlcnMgLSBBZGRpdGlvbmFsIGhlYWRlcnMgbWFwcGluZyBmb3IgbXVsdGlwYXJ0IGh0dHAocykgdXBsb2Fkc1xuICogQHByb3BlcnR5IHs/c3RyaW5nfSBmaWxlRmllbGROYW1lIFtmaWxlXSAtIFRoZSBuYW1lIG9mIHRoZSBmb3JtIGZpZWxkLCB3aGVyZSB0aGUgZmlsZSBjb250ZW50IEJMT0Igc2hvdWxkIGJlIHN0b3JlZCBmb3JcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwKHMpIHVwbG9hZHNcbiAqIEBwcm9wZXJ0eSB7P09iamVjdHxBcnJheTxQYWlyPn0gZm9ybUZpZWxkcyAtIEFkZGl0aW9uYWwgZm9ybSBmaWVsZHMgZm9yIG11bHRpcGFydCBodHRwKHMpIHVwbG9hZHNcbiAqL1xuXG4vKipcbiAqIFN0b3BzIHBlcmZvcm1hbmNlIHByb2ZpbGluZyBmb3IgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogVGhlIHJlc3VsdGluZyBmaWxlIGluIC50cmFjZSBmb3JtYXQgY2FuIGJlIGVpdGhlciByZXR1cm5lZFxuICogZGlyZWN0bHkgYXMgYmFzZTY0LWVuY29kZWQgemlwIGFyY2hpdmUgb3IgdXBsb2FkZWQgdG8gYSByZW1vdGUgbG9jYXRpb25cbiAqIChzdWNoIGZpbGVzIGNhbiBiZSBwcmV0dHkgbGFyZ2UpLiBBZnRlcndhcmRzIGl0IGlzIHBvc3NpYmxlIHRvIHVuYXJjaGl2ZSBhbmRcbiAqIG9wZW4gc3VjaCBmaWxlIHdpdGggWGNvZGUgRGV2IFRvb2xzLlxuICpcbiAqIEBwYXJhbSB7P1N0b3BSZWNvcmRpbmdPcHRpb25zfSBvcHRzIC0gVGhlIHNldCBvZiBwb3NzaWJsZSBzdG9wIHJlY29yZCBvcHRpb25zXG4gKiBAcmV0dXJuIHtzdHJpbmd9IEVpdGhlciBhbiBlbXB0eSBzdHJpbmcgaWYgdGhlIHVwbG9hZCB3YXMgc3VjY2Vzc2Z1bCBvciBiYXNlLTY0IGVuY29kZWRcbiAqIGNvbnRlbnQgb2YgemlwcGVkIC50cmFjZSBmaWxlLlxuICogQHRocm93cyB7RXJyb3J9IElmIG5vIHBlcmZvcm1hbmNlIHJlY29yZGluZyB3aXRoIGdpdmVuIHByb2ZpbGUgbmFtZS9kZXZpY2UgdWRpZCBjb21iaW5hdGlvblxuICogaGFzIGJlZW4gc3RhcnRlZCBiZWZvcmUgb3IgdGhlIHJlc3VsdGluZyAudHJhY2UgZmlsZSBoYXMgbm90IGJlZW4gZ2VuZXJhdGVkIHByb3Blcmx5LlxuICovXG5jb21tYW5kcy5tb2JpbGVTdG9wUGVyZlJlY29yZCA9IGFzeW5jIGZ1bmN0aW9uIG1vYmlsZVN0b3BQZXJmUmVjb3JkIChvcHRzID0ge30pIHtcbiAgaWYgKCF0aGlzLmlzRmVhdHVyZUVuYWJsZWQoUEVSRl9SRUNPUkRfRkVBVF9OQU1FKSAmJiAhdGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KFBFUkZfUkVDT1JEX1NFQ1VSSVRZX01FU1NBR0UpO1xuICB9XG5cbiAgaWYgKF8uaXNFbXB0eSh0aGlzLl9wZXJmUmVjb3JkZXJzKSkge1xuICAgIGxvZy5pbmZvKCdObyBwZXJmb3JtYW5jZSByZWNvcmRlcnMgaGF2ZSBiZWVuIHN0YXJ0ZWQuIERvaW5nIG5vdGhpbmcnKTtcbiAgICByZXR1cm4gJyc7XG4gIH1cblxuICBjb25zdCB7XG4gICAgcHJvZmlsZU5hbWUgPSBERUZBVUxUX1BST0ZJTEVfTkFNRSxcbiAgfSA9IG9wdHM7XG5cbiAgY29uc3QgcmVjb3JkZXJzID0gdGhpcy5fcGVyZlJlY29yZGVyc1xuICAgIC5maWx0ZXIoKHgpID0+IHgucHJvZmlsZU5hbWUgPT09IHByb2ZpbGVOYW1lKTtcbiAgaWYgKF8uaXNFbXB0eShyZWNvcmRlcnMpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZXJlIGFyZSBubyByZWNvcmRzIGZvciBwZXJmb3JtYW5jZSBwcm9maWxlICcke3Byb2ZpbGVOYW1lfScgYCArXG4gICAgICBgYW5kIGRldmljZSAke3RoaXMub3B0cy5kZXZpY2UudWRpZH0uIEhhdmUgeW91IHN0YXJ0ZWQgdGhlIHByb2ZpbGluZyBiZWZvcmU/YCk7XG4gIH1cbiAgY29uc3QgcmVzdWx0UGF0aCA9IGF3YWl0IHJlY29yZGVyc1swXS5zdG9wKCk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKHJlc3VsdFBhdGgpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZXJlIGlzIG5vIC4ke0RFRkFVTFRfRVhUfSBmaWxlIGZvdW5kIGZvciBwZXJmb3JtYW5jZSBwcm9maWxlICcke3Byb2ZpbGVOYW1lfScgYCArXG4gICAgICBgYW5kIGRldmljZSAke3RoaXMub3B0cy5kZXZpY2UudWRpZH0uIE1ha2Ugc3VyZSB0aGUgcHJvZmlsZSBpcyBzdXBwb3J0ZWQgb24gdGhpcyBkZXZpY2UuIGAgK1xuICAgICAgYFlvdSBjb3VsZCB1c2UgJ2luc3RydW1lbnRzIC1zJyBjb21tYW5kIHRvIHNlZSB0aGUgbGlzdCBvZiBhbGwgYXZhaWxhYmxlIHByb2ZpbGVzLmApO1xuICB9XG5cbiAgcmV0dXJuIGF3YWl0IGVuY29kZUJhc2U2NE9yVXBsb2FkKHJlc3VsdFBhdGgsIG9wdHMucmVtb3RlUGF0aCwgb3B0cyk7XG59O1xuXG5cbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3BlcmZvcm1hbmNlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
