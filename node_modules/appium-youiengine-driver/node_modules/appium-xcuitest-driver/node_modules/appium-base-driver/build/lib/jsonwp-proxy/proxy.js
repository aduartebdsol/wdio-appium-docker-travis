"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.JWProxy = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _axios = _interopRequireDefault(require("axios"));

var _status = require("../jsonwp-status/status");

var _errors = require("../protocol/errors");

var _protocol = require("../protocol");

var _protocolConverter = _interopRequireDefault(require("./protocol-converter"));

var _helpers = require("../protocol/helpers");

var _sessionsCache = _interopRequireDefault(require("../protocol/sessions-cache"));

var _http = _interopRequireDefault(require("http"));

var _https = _interopRequireDefault(require("https"));

const log = _appiumSupport.logger.getLogger('WD Proxy');

const LOG_OBJ_LENGTH = 1024;
const DEFAULT_REQUEST_TIMEOUT = 240000;
const {
  MJSONWP,
  W3C
} = _protocol.PROTOCOLS;

class JWProxy {
  constructor(opts = {}) {
    _lodash.default.defaults(this, opts, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: _protocol.DEFAULT_BASE_PATH,
      reqBasePath: _protocol.DEFAULT_BASE_PATH,
      sessionId: null,
      timeout: DEFAULT_REQUEST_TIMEOUT,
      keepAlive: true
    });

    this.scheme = this.scheme.toLowerCase();
    this._activeRequests = [];
    this._reqCancelSource = _axios.default.CancelToken.source();
    this._downstreamProtocol = null;
    this.protocolConverter = new _protocolConverter.default(this.proxy.bind(this));
  }

  async request(requestConfig) {
    const reqPromise = (0, _axios.default)(requestConfig);

    this._activeRequests.push(reqPromise);

    try {
      return await reqPromise;
    } finally {
      _lodash.default.pull(this._activeRequests, reqPromise);
    }
  }

  getActiveRequestsCount() {
    return this._activeRequests.length;
  }

  cancelActiveRequests() {
    try {
      this._reqCancelSource.cancel('The request has been canceled');
    } finally {
      this._activeRequests = [];
    }
  }

  endpointRequiresSessionId(endpoint) {
    return !_lodash.default.includes(['/session', '/sessions', '/status'], endpoint);
  }

  set downstreamProtocol(value) {
    this._downstreamProtocol = value;
    this.protocolConverter.downstreamProtocol = value;
  }

  get downstreamProtocol() {
    return this._downstreamProtocol;
  }

  getUrlForProxy(url) {
    if (url === '') {
      url = '/';
    }

    const proxyBase = `${this.scheme}://${this.server}:${this.port}${this.base}`;
    const endpointRe = '(/(session|status))';
    let remainingUrl = '';

    if (/^http/.test(url)) {
      const first = new RegExp(`(https?://.+)${endpointRe}`).exec(url);

      if (!first) {
        throw new Error('Got a complete url but could not extract JWP endpoint');
      }

      remainingUrl = url.replace(first[1], '');
    } else if (new RegExp('^/').test(url)) {
      remainingUrl = url;
    } else {
      throw new Error(`Did not know what to do with url '${url}'`);
    }

    const stripPrefixRe = new RegExp('^.*?(/(session|status).*)$');

    if (stripPrefixRe.test(remainingUrl)) {
      remainingUrl = stripPrefixRe.exec(remainingUrl)[1];
    }

    if (!new RegExp(endpointRe).test(remainingUrl)) {
      remainingUrl = `/session/${this.sessionId}${remainingUrl}`;
    }

    const requiresSessionId = this.endpointRequiresSessionId(remainingUrl);

    if (requiresSessionId && this.sessionId === null) {
      throw new Error('Trying to proxy a session command without session id');
    }

    const sessionBaseRe = new RegExp('^/session/([^/]+)');

    if (sessionBaseRe.test(remainingUrl)) {
      const match = sessionBaseRe.exec(remainingUrl);
      remainingUrl = remainingUrl.replace(match[1], this.sessionId);
    } else if (requiresSessionId) {
      throw new Error(`Could not find :session section for url: ${remainingUrl}`);
    }

    remainingUrl = remainingUrl.replace(/\/$/, '');
    return proxyBase + remainingUrl;
  }

  async proxy(url, method, body = null) {
    method = method.toUpperCase();
    const newUrl = this.getUrlForProxy(url);

    const truncateBody = content => _lodash.default.truncate(_lodash.default.isString(content) ? content : JSON.stringify(content), {
      length: LOG_OBJ_LENGTH
    });

    const reqOpts = {
      url: newUrl,
      method,
      headers: {
        'content-type': 'application/json; charset=utf-8',
        'user-agent': 'appium',
        accept: 'application/json, */*'
      },
      timeout: this.timeout,
      httpAgent: new _http.default.Agent({
        keepAlive: this.keepAlive
      }),
      httpsAgent: new _https.default.Agent({
        keepAlive: this.keepAlive
      }),
      cancelToken: this._reqCancelSource.token
    };

    if (_appiumSupport.util.hasValue(body) && method !== 'GET') {
      if (typeof body !== 'object') {
        try {
          reqOpts.data = JSON.parse(body);
        } catch (e) {
          throw new Error(`Cannot interpret the request body as valid JSON: ${truncateBody(body)}`);
        }
      } else {
        reqOpts.data = body;
      }
    }

    log.debug(`Proxying [${method} ${url || '/'}] to [${method} ${newUrl}] ` + (reqOpts.data ? `with body: ${truncateBody(reqOpts.data)}` : 'with no body'));

    const throwProxyError = error => {
      const err = new Error(`The request to ${url} has failed`);
      err.response = {
        data: error,
        status: 500
      };
      throw err;
    };

    let isResponseLogged = false;

    try {
      const {
        data,
        status,
        headers
      } = await this.request(reqOpts);

      if (!_lodash.default.isPlainObject(data)) {
        throwProxyError(data);
      }

      log.debug(`Got response with status ${status}: ${truncateBody(data)}`);
      isResponseLogged = true;
      const isSessionCreationRequest = /\/session$/.test(url) && method === 'POST';

      if (isSessionCreationRequest) {
        if (status === 200) {
          this.sessionId = data.sessionId || (data.value || {}).sessionId;
        }

        this.downstreamProtocol = this.getProtocolFromResBody(data);
        log.info(`Determined the downstream protocol as '${this.downstreamProtocol}'`);
      }

      if (_lodash.default.has(data, 'status') && parseInt(data.status, 10) !== 0) {
        throwProxyError(data);
      }

      const res = {
        statusCode: status,
        headers,
        body: data
      };
      return [res, data];
    } catch (e) {
      var _e$response, _e$response2;

      let proxyErrorMsg = e.message;

      if (_appiumSupport.util.hasValue(e.response)) {
        if (!isResponseLogged) {
          const error = truncateBody(e.response.data);
          log.info(_appiumSupport.util.hasValue(e.response.status) ? `Got response with status ${e.response.status}: ${error}` : `Got response with unknown status: ${error}`);
        }
      } else {
        proxyErrorMsg = `Could not proxy command to the remote server. Original error: ${e.message}`;
        log.warn(e.message);
        log.debug(e.stack);
      }

      throw new _errors.errors.ProxyRequestError(proxyErrorMsg, (_e$response = e.response) === null || _e$response === void 0 ? void 0 : _e$response.data, (_e$response2 = e.response) === null || _e$response2 === void 0 ? void 0 : _e$response2.status);
    }
  }

  getProtocolFromResBody(resObj) {
    if (_lodash.default.isInteger(resObj.status)) {
      return MJSONWP;
    }

    if (!_lodash.default.isUndefined(resObj.value)) {
      return W3C;
    }
  }

  requestToCommandName(url, method) {
    const extractCommandName = pattern => {
      const pathMatch = pattern.exec(url);
      return pathMatch ? (0, _protocol.routeToCommandName)(pathMatch[1], method, this.reqBasePath) : null;
    };

    let commandName = (0, _protocol.routeToCommandName)(url, method, this.reqBasePath);

    if (!commandName && _lodash.default.includes(url, `${this.reqBasePath}/session/`)) {
      commandName = extractCommandName(new RegExp(`${_lodash.default.escapeRegExp(this.reqBasePath)}/session/[^/]+(.+)`));
    }

    if (!commandName && _lodash.default.includes(url, this.reqBasePath)) {
      commandName = extractCommandName(new RegExp(`${_lodash.default.escapeRegExp(this.reqBasePath)}(/.+)`));
    }

    return commandName;
  }

  async proxyCommand(url, method, body = null) {
    const commandName = this.requestToCommandName(url, method);

    if (!commandName) {
      return await this.proxy(url, method, body);
    }

    log.debug(`Matched '${url}' to command name '${commandName}'`);
    return await this.protocolConverter.convertAndProxy(commandName, url, method, body);
  }

  async command(url, method, body = null) {
    let response;
    let resBodyObj;

    try {
      [response, resBodyObj] = await this.proxyCommand(url, method, body);
    } catch (err) {
      if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
        throw err.getActualError();
      }

      throw new _errors.errors.UnknownError(err.message);
    }

    const protocol = this.getProtocolFromResBody(resBodyObj);

    if (protocol === MJSONWP) {
      if (response.statusCode === 200 && resBodyObj.status === 0) {
        return resBodyObj.value;
      }

      const status = parseInt(resBodyObj.status, 10);

      if (!isNaN(status) && status !== 0) {
        let message = resBodyObj.value;

        if (_lodash.default.has(message, 'message')) {
          message = message.message;
        }

        throw (0, _errors.errorFromMJSONWPStatusCode)(status, _lodash.default.isEmpty(message) ? (0, _status.getSummaryByCode)(status) : message);
      }
    } else if (protocol === W3C) {
      if (response.statusCode < 300) {
        return resBodyObj.value;
      }

      if (_lodash.default.isPlainObject(resBodyObj.value) && resBodyObj.value.error) {
        throw (0, _errors.errorFromW3CJsonCode)(resBodyObj.value.error, resBodyObj.value.message, resBodyObj.value.stacktrace);
      }
    } else if (response.statusCode === 200) {
      return resBodyObj;
    }

    throw new _errors.errors.UnknownError(`Did not know what to do with response code '${response.statusCode}' ` + `and response body '${_lodash.default.truncate(JSON.stringify(resBodyObj), {
      length: 300
    })}'`);
  }

  getSessionIdFromUrl(url) {
    const match = url.match(/\/session\/([^/]+)/);
    return match ? match[1] : null;
  }

  async proxyReqRes(req, res) {
    const [response, resBodyObj] = await this.proxyCommand(req.originalUrl, req.method, req.body);
    res.headers = response.headers;
    res.set('content-type', response.headers['content-type']);
    const reqSessionId = this.getSessionIdFromUrl(req.originalUrl);

    if (_lodash.default.has(resBodyObj, 'sessionId')) {
      if (reqSessionId) {
        log.info(`Replacing sessionId ${resBodyObj.sessionId} with ${reqSessionId}`);
        resBodyObj.sessionId = reqSessionId;
      } else if (this.sessionId) {
        log.info(`Replacing sessionId ${resBodyObj.sessionId} with ${this.sessionId}`);
        resBodyObj.sessionId = this.sessionId;
      }
    }

    resBodyObj.value = (0, _helpers.formatResponseValue)(resBodyObj.value);
    (0, _helpers.formatStatus)(resBodyObj, res.statusCode, _sessionsCache.default.getProtocol(reqSessionId));
    res.status(response.statusCode).send(JSON.stringify(resBodyObj));
  }

}

exports.JWProxy = JWProxy;
var _default = JWProxy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiXSwibmFtZXMiOlsibG9nIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiTE9HX09CSl9MRU5HVEgiLCJERUZBVUxUX1JFUVVFU1RfVElNRU9VVCIsIk1KU09OV1AiLCJXM0MiLCJQUk9UT0NPTFMiLCJKV1Byb3h5IiwiY29uc3RydWN0b3IiLCJvcHRzIiwiXyIsImRlZmF1bHRzIiwic2NoZW1lIiwic2VydmVyIiwicG9ydCIsImJhc2UiLCJERUZBVUxUX0JBU0VfUEFUSCIsInJlcUJhc2VQYXRoIiwic2Vzc2lvbklkIiwidGltZW91dCIsImtlZXBBbGl2ZSIsInRvTG93ZXJDYXNlIiwiX2FjdGl2ZVJlcXVlc3RzIiwiX3JlcUNhbmNlbFNvdXJjZSIsImF4aW9zIiwiQ2FuY2VsVG9rZW4iLCJzb3VyY2UiLCJfZG93bnN0cmVhbVByb3RvY29sIiwicHJvdG9jb2xDb252ZXJ0ZXIiLCJQcm90b2NvbENvbnZlcnRlciIsInByb3h5IiwiYmluZCIsInJlcXVlc3QiLCJyZXF1ZXN0Q29uZmlnIiwicmVxUHJvbWlzZSIsInB1c2giLCJwdWxsIiwiZ2V0QWN0aXZlUmVxdWVzdHNDb3VudCIsImxlbmd0aCIsImNhbmNlbEFjdGl2ZVJlcXVlc3RzIiwiY2FuY2VsIiwiZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZCIsImVuZHBvaW50IiwiaW5jbHVkZXMiLCJkb3duc3RyZWFtUHJvdG9jb2wiLCJ2YWx1ZSIsImdldFVybEZvclByb3h5IiwidXJsIiwicHJveHlCYXNlIiwiZW5kcG9pbnRSZSIsInJlbWFpbmluZ1VybCIsInRlc3QiLCJmaXJzdCIsIlJlZ0V4cCIsImV4ZWMiLCJFcnJvciIsInJlcGxhY2UiLCJzdHJpcFByZWZpeFJlIiwicmVxdWlyZXNTZXNzaW9uSWQiLCJzZXNzaW9uQmFzZVJlIiwibWF0Y2giLCJtZXRob2QiLCJib2R5IiwidG9VcHBlckNhc2UiLCJuZXdVcmwiLCJ0cnVuY2F0ZUJvZHkiLCJjb250ZW50IiwidHJ1bmNhdGUiLCJpc1N0cmluZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJyZXFPcHRzIiwiaGVhZGVycyIsImFjY2VwdCIsImh0dHBBZ2VudCIsImh0dHAiLCJBZ2VudCIsImh0dHBzQWdlbnQiLCJodHRwcyIsImNhbmNlbFRva2VuIiwidG9rZW4iLCJ1dGlsIiwiaGFzVmFsdWUiLCJkYXRhIiwicGFyc2UiLCJlIiwiZGVidWciLCJ0aHJvd1Byb3h5RXJyb3IiLCJlcnJvciIsImVyciIsInJlc3BvbnNlIiwic3RhdHVzIiwiaXNSZXNwb25zZUxvZ2dlZCIsImlzUGxhaW5PYmplY3QiLCJpc1Nlc3Npb25DcmVhdGlvblJlcXVlc3QiLCJnZXRQcm90b2NvbEZyb21SZXNCb2R5IiwiaW5mbyIsImhhcyIsInBhcnNlSW50IiwicmVzIiwic3RhdHVzQ29kZSIsInByb3h5RXJyb3JNc2ciLCJtZXNzYWdlIiwid2FybiIsInN0YWNrIiwiZXJyb3JzIiwiUHJveHlSZXF1ZXN0RXJyb3IiLCJyZXNPYmoiLCJpc0ludGVnZXIiLCJpc1VuZGVmaW5lZCIsInJlcXVlc3RUb0NvbW1hbmROYW1lIiwiZXh0cmFjdENvbW1hbmROYW1lIiwicGF0dGVybiIsInBhdGhNYXRjaCIsImNvbW1hbmROYW1lIiwiZXNjYXBlUmVnRXhwIiwicHJveHlDb21tYW5kIiwiY29udmVydEFuZFByb3h5IiwiY29tbWFuZCIsInJlc0JvZHlPYmoiLCJnZXRBY3R1YWxFcnJvciIsIlVua25vd25FcnJvciIsInByb3RvY29sIiwiaXNOYU4iLCJpc0VtcHR5Iiwic3RhY2t0cmFjZSIsImdldFNlc3Npb25JZEZyb21VcmwiLCJwcm94eVJlcVJlcyIsInJlcSIsIm9yaWdpbmFsVXJsIiwic2V0IiwicmVxU2Vzc2lvbklkIiwiU0VTU0lPTlNfQ0FDSEUiLCJnZXRQcm90b2NvbCIsInNlbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7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LEVBQXdCeEMsUUFBUSxDQUFDbEIsT0FBVCxDQUFpQixjQUFqQixDQUF4QjtBQUlBLFVBQU0yRCxZQUFZLEdBQUcsS0FBS0wsbUJBQUwsQ0FBeUJFLEdBQUcsQ0FBQ0MsV0FBN0IsQ0FBckI7O0FBQ0EsUUFBSXZILGdCQUFFdUYsR0FBRixDQUFNc0IsVUFBTixFQUFrQixXQUFsQixDQUFKLEVBQW9DO0FBQ2xDLFVBQUlZLFlBQUosRUFBa0I7QUFDaEJwSSxRQUFBQSxHQUFHLENBQUNpRyxJQUFKLENBQVUsdUJBQXNCdUIsVUFBVSxDQUFDckcsU0FBVSxTQUFRaUgsWUFBYSxFQUExRTtBQUNBWixRQUFBQSxVQUFVLENBQUNyRyxTQUFYLEdBQXVCaUgsWUFBdkI7QUFDRCxPQUhELE1BR08sSUFBSSxLQUFLakgsU0FBVCxFQUFvQjtBQUN6Qm5CLFFBQUFBLEdBQUcsQ0FBQ2lHLElBQUosQ0FBVSx1QkFBc0J1QixVQUFVLENBQUNyRyxTQUFVLFNBQVEsS0FBS0EsU0FBVSxFQUE1RTtBQUNBcUcsUUFBQUEsVUFBVSxDQUFDckcsU0FBWCxHQUF1QixLQUFLQSxTQUE1QjtBQUNEO0FBQ0Y7O0FBQ0RxRyxJQUFBQSxVQUFVLENBQUMxRSxLQUFYLEdBQW1CLGtDQUFvQjBFLFVBQVUsQ0FBQzFFLEtBQS9CLENBQW5CO0FBQ0EsK0JBQWEwRSxVQUFiLEVBQXlCcEIsR0FBRyxDQUFDQyxVQUE3QixFQUF5Q2dDLHVCQUFlQyxXQUFmLENBQTJCRixZQUEzQixDQUF6QztBQUNBaEMsSUFBQUEsR0FBRyxDQUFDUixNQUFKLENBQVdELFFBQVEsQ0FBQ1UsVUFBcEIsRUFBZ0NrQyxJQUFoQyxDQUFxQ2pFLElBQUksQ0FBQ0MsU0FBTCxDQUFlaUQsVUFBZixDQUFyQztBQUNEOztBQTlTVzs7O2VBa1RDaEgsTyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBsb2dnZXIsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHsgZ2V0U3VtbWFyeUJ5Q29kZSB9IGZyb20gJy4uL2pzb253cC1zdGF0dXMvc3RhdHVzJztcbmltcG9ydCB7XG4gIGVycm9ycywgaXNFcnJvclR5cGUsIGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlLCBlcnJvckZyb21XM0NKc29uQ29kZVxufSBmcm9tICcuLi9wcm90b2NvbC9lcnJvcnMnO1xuaW1wb3J0IHsgUFJPVE9DT0xTLCByb3V0ZVRvQ29tbWFuZE5hbWUsIERFRkFVTFRfQkFTRV9QQVRIIH0gZnJvbSAnLi4vcHJvdG9jb2wnO1xuaW1wb3J0IFByb3RvY29sQ29udmVydGVyIGZyb20gJy4vcHJvdG9jb2wtY29udmVydGVyJztcbmltcG9ydCB7IGZvcm1hdFJlc3BvbnNlVmFsdWUsIGZvcm1hdFN0YXR1cyB9IGZyb20gJy4uL3Byb3RvY29sL2hlbHBlcnMnO1xuaW1wb3J0IFNFU1NJT05TX0NBQ0hFIGZyb20gJy4uL3Byb3RvY29sL3Nlc3Npb25zLWNhY2hlJztcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0IGh0dHBzIGZyb20gJ2h0dHBzJztcblxuXG5jb25zdCBsb2cgPSBsb2dnZXIuZ2V0TG9nZ2VyKCdXRCBQcm94eScpO1xuLy8gVE9ETzogTWFrZSB0aGlzIHZhbHVlIGNvbmZpZ3VyYWJsZSBhcyBhIHNlcnZlciBzaWRlIGNhcGFiaWxpdHlcbmNvbnN0IExPR19PQkpfTEVOR1RIID0gMTAyNDsgLy8gTUFYIExFTkdUSCBMb2dnZWQgdG8gZmlsZSAvIGNvbnNvbGVcbmNvbnN0IERFRkFVTFRfUkVRVUVTVF9USU1FT1VUID0gMjQwMDAwO1xuXG5jb25zdCB7TUpTT05XUCwgVzNDfSA9IFBST1RPQ09MUztcblxuY2xhc3MgSldQcm94eSB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBfLmRlZmF1bHRzKHRoaXMsIG9wdHMsIHtcbiAgICAgIHNjaGVtZTogJ2h0dHAnLFxuICAgICAgc2VydmVyOiAnbG9jYWxob3N0JyxcbiAgICAgIHBvcnQ6IDQ0NDQsXG4gICAgICBiYXNlOiBERUZBVUxUX0JBU0VfUEFUSCxcbiAgICAgIHJlcUJhc2VQYXRoOiBERUZBVUxUX0JBU0VfUEFUSCxcbiAgICAgIHNlc3Npb25JZDogbnVsbCxcbiAgICAgIHRpbWVvdXQ6IERFRkFVTFRfUkVRVUVTVF9USU1FT1VULFxuICAgICAga2VlcEFsaXZlOiB0cnVlLFxuICAgIH0pO1xuICAgIHRoaXMuc2NoZW1lID0gdGhpcy5zY2hlbWUudG9Mb3dlckNhc2UoKTtcbiAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cyA9IFtdO1xuICAgIHRoaXMuX3JlcUNhbmNlbFNvdXJjZSA9IGF4aW9zLkNhbmNlbFRva2VuLnNvdXJjZSgpO1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IG51bGw7XG4gICAgdGhpcy5wcm90b2NvbENvbnZlcnRlciA9IG5ldyBQcm90b2NvbENvbnZlcnRlcih0aGlzLnByb3h5LmJpbmQodGhpcykpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm1zIHJlcXVlc3RzIHRvIHRoZSBkb3duc3RyZWFtIHNlcnZlclxuICAgKlxuICAgKiBAcHJpdmF0ZSAtIERvIG5vdCBjYWxsIHRoaXMgbWV0aG9kIGRpcmVjdGx5LFxuICAgKiBpdCB1c2VzIGNsaWVudC1zcGVjaWZpYyBhcmd1bWVudHMgYW5kIHJlc3BvbnNlcyFcbiAgICpcbiAgICogQHBhcmFtIHtBeGlvc1JlcXVlc3RDb25maWd9IHJlcXVlc3RDb25maWdcbiAgICogQHJldHVybnMge0F4aW9zUmVzcG9uc2V9XG4gICAqL1xuICBhc3luYyByZXF1ZXN0IChyZXF1ZXN0Q29uZmlnKSB7XG4gICAgY29uc3QgcmVxUHJvbWlzZSA9IGF4aW9zKHJlcXVlc3RDb25maWcpO1xuICAgIHRoaXMuX2FjdGl2ZVJlcXVlc3RzLnB1c2gocmVxUHJvbWlzZSk7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCByZXFQcm9taXNlO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBfLnB1bGwodGhpcy5fYWN0aXZlUmVxdWVzdHMsIHJlcVByb21pc2UpO1xuICAgIH1cbiAgfVxuXG4gIGdldEFjdGl2ZVJlcXVlc3RzQ291bnQgKCkge1xuICAgIHJldHVybiB0aGlzLl9hY3RpdmVSZXF1ZXN0cy5sZW5ndGg7XG4gIH1cblxuICBjYW5jZWxBY3RpdmVSZXF1ZXN0cyAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuX3JlcUNhbmNlbFNvdXJjZS5jYW5jZWwoJ1RoZSByZXF1ZXN0IGhhcyBiZWVuIGNhbmNlbGVkJyk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuX2FjdGl2ZVJlcXVlc3RzID0gW107XG4gICAgfVxuICB9XG5cbiAgZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZCAoZW5kcG9pbnQpIHtcbiAgICByZXR1cm4gIV8uaW5jbHVkZXMoWycvc2Vzc2lvbicsICcvc2Vzc2lvbnMnLCAnL3N0YXR1cyddLCBlbmRwb2ludCk7XG4gIH1cblxuICBzZXQgZG93bnN0cmVhbVByb3RvY29sICh2YWx1ZSkge1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IHZhbHVlO1xuICAgIHRoaXMucHJvdG9jb2xDb252ZXJ0ZXIuZG93bnN0cmVhbVByb3RvY29sID0gdmFsdWU7XG4gIH1cblxuICBnZXQgZG93bnN0cmVhbVByb3RvY29sICgpIHtcbiAgICByZXR1cm4gdGhpcy5fZG93bnN0cmVhbVByb3RvY29sO1xuICB9XG5cbiAgZ2V0VXJsRm9yUHJveHkgKHVybCkge1xuICAgIGlmICh1cmwgPT09ICcnKSB7XG4gICAgICB1cmwgPSAnLyc7XG4gICAgfVxuICAgIGNvbnN0IHByb3h5QmFzZSA9IGAke3RoaXMuc2NoZW1lfTovLyR7dGhpcy5zZXJ2ZXJ9OiR7dGhpcy5wb3J0fSR7dGhpcy5iYXNlfWA7XG4gICAgY29uc3QgZW5kcG9pbnRSZSA9ICcoLyhzZXNzaW9ufHN0YXR1cykpJztcbiAgICBsZXQgcmVtYWluaW5nVXJsID0gJyc7XG4gICAgaWYgKC9eaHR0cC8udGVzdCh1cmwpKSB7XG4gICAgICBjb25zdCBmaXJzdCA9IChuZXcgUmVnRXhwKGAoaHR0cHM/Oi8vLispJHtlbmRwb2ludFJlfWApKS5leGVjKHVybCk7XG4gICAgICBpZiAoIWZpcnN0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignR290IGEgY29tcGxldGUgdXJsIGJ1dCBjb3VsZCBub3QgZXh0cmFjdCBKV1AgZW5kcG9pbnQnKTtcbiAgICAgIH1cbiAgICAgIHJlbWFpbmluZ1VybCA9IHVybC5yZXBsYWNlKGZpcnN0WzFdLCAnJyk7XG4gICAgfSBlbHNlIGlmICgobmV3IFJlZ0V4cCgnXi8nKSkudGVzdCh1cmwpKSB7XG4gICAgICByZW1haW5pbmdVcmwgPSB1cmw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRGlkIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCB1cmwgJyR7dXJsfSdgKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHJpcFByZWZpeFJlID0gbmV3IFJlZ0V4cCgnXi4qPygvKHNlc3Npb258c3RhdHVzKS4qKSQnKTtcbiAgICBpZiAoc3RyaXBQcmVmaXhSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHN0cmlwUHJlZml4UmUuZXhlYyhyZW1haW5pbmdVcmwpWzFdO1xuICAgIH1cblxuICAgIGlmICghKG5ldyBSZWdFeHAoZW5kcG9pbnRSZSkpLnRlc3QocmVtYWluaW5nVXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gYC9zZXNzaW9uLyR7dGhpcy5zZXNzaW9uSWR9JHtyZW1haW5pbmdVcmx9YDtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1aXJlc1Nlc3Npb25JZCA9IHRoaXMuZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZChyZW1haW5pbmdVcmwpO1xuXG4gICAgaWYgKHJlcXVpcmVzU2Vzc2lvbklkICYmIHRoaXMuc2Vzc2lvbklkID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byBwcm94eSBhIHNlc3Npb24gY29tbWFuZCB3aXRob3V0IHNlc3Npb24gaWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBzZXNzaW9uQmFzZVJlID0gbmV3IFJlZ0V4cCgnXi9zZXNzaW9uLyhbXi9dKyknKTtcbiAgICBpZiAoc2Vzc2lvbkJhc2VSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIC8vIHdlIGhhdmUgc29tZXRoaW5nIGxpa2UgL3Nlc3Npb24vOmlkL2Zvb2Jhciwgc28gd2UgbmVlZCB0byByZXBsYWNlXG4gICAgICAvLyB0aGUgc2Vzc2lvbiBpZFxuICAgICAgY29uc3QgbWF0Y2ggPSBzZXNzaW9uQmFzZVJlLmV4ZWMocmVtYWluaW5nVXJsKTtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHJlbWFpbmluZ1VybC5yZXBsYWNlKG1hdGNoWzFdLCB0aGlzLnNlc3Npb25JZCk7XG4gICAgfSBlbHNlIGlmIChyZXF1aXJlc1Nlc3Npb25JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCA6c2Vzc2lvbiBzZWN0aW9uIGZvciB1cmw6ICR7cmVtYWluaW5nVXJsfWApO1xuICAgIH1cbiAgICByZW1haW5pbmdVcmwgPSByZW1haW5pbmdVcmwucmVwbGFjZSgvXFwvJC8sICcnKTsgLy8gY2FuJ3QgaGF2ZSB0cmFpbGluZyBzbGFzaGVzXG5cbiAgICByZXR1cm4gcHJveHlCYXNlICsgcmVtYWluaW5nVXJsO1xuICB9XG5cbiAgYXN5bmMgcHJveHkgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIG1ldGhvZCA9IG1ldGhvZC50b1VwcGVyQ2FzZSgpO1xuICAgIGNvbnN0IG5ld1VybCA9IHRoaXMuZ2V0VXJsRm9yUHJveHkodXJsKTtcbiAgICBjb25zdCB0cnVuY2F0ZUJvZHkgPSAoY29udGVudCkgPT4gXy50cnVuY2F0ZShcbiAgICAgIF8uaXNTdHJpbmcoY29udGVudCkgPyBjb250ZW50IDogSlNPTi5zdHJpbmdpZnkoY29udGVudCksXG4gICAgICB7IGxlbmd0aDogTE9HX09CSl9MRU5HVEggfSk7XG4gICAgY29uc3QgcmVxT3B0cyA9IHtcbiAgICAgIHVybDogbmV3VXJsLFxuICAgICAgbWV0aG9kLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnLFxuICAgICAgICAndXNlci1hZ2VudCc6ICdhcHBpdW0nLFxuICAgICAgICBhY2NlcHQ6ICdhcHBsaWNhdGlvbi9qc29uLCAqLyonLFxuICAgICAgfSxcbiAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICAgIGh0dHBBZ2VudDogbmV3IGh0dHAuQWdlbnQoeyBrZWVwQWxpdmU6IHRoaXMua2VlcEFsaXZlIH0pLFxuICAgICAgaHR0cHNBZ2VudDogbmV3IGh0dHBzLkFnZW50KHsga2VlcEFsaXZlOiB0aGlzLmtlZXBBbGl2ZSB9KSxcbiAgICAgIGNhbmNlbFRva2VuOiB0aGlzLl9yZXFDYW5jZWxTb3VyY2UudG9rZW4sXG4gICAgfTtcbiAgICAvLyBHRVQgbWV0aG9kcyBzaG91bGRuJ3QgaGF2ZSBhbnkgYm9keS4gTW9zdCBzZXJ2ZXJzIGFyZSBPSyB3aXRoIHRoaXMsIGJ1dCBXZWJEcml2ZXJBZ2VudCB0aHJvd3MgNDAwIGVycm9yc1xuICAgIGlmICh1dGlsLmhhc1ZhbHVlKGJvZHkpICYmIG1ldGhvZCAhPT0gJ0dFVCcpIHtcbiAgICAgIGlmICh0eXBlb2YgYm9keSAhPT0gJ29iamVjdCcpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICByZXFPcHRzLmRhdGEgPSBKU09OLnBhcnNlKGJvZHkpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgaW50ZXJwcmV0IHRoZSByZXF1ZXN0IGJvZHkgYXMgdmFsaWQgSlNPTjogJHt0cnVuY2F0ZUJvZHkoYm9keSl9YCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcU9wdHMuZGF0YSA9IGJvZHk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbG9nLmRlYnVnKGBQcm94eWluZyBbJHttZXRob2R9ICR7dXJsIHx8ICcvJ31dIHRvIFske21ldGhvZH0gJHtuZXdVcmx9XSBgICtcbiAgICAgIChyZXFPcHRzLmRhdGEgPyBgd2l0aCBib2R5OiAke3RydW5jYXRlQm9keShyZXFPcHRzLmRhdGEpfWAgOiAnd2l0aCBubyBib2R5JykpO1xuXG4gICAgY29uc3QgdGhyb3dQcm94eUVycm9yID0gKGVycm9yKSA9PiB7XG4gICAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoYFRoZSByZXF1ZXN0IHRvICR7dXJsfSBoYXMgZmFpbGVkYCk7XG4gICAgICBlcnIucmVzcG9uc2UgPSB7XG4gICAgICAgIGRhdGE6IGVycm9yLFxuICAgICAgICBzdGF0dXM6IDUwMFxuICAgICAgfTtcbiAgICAgIHRocm93IGVycjtcbiAgICB9O1xuICAgIGxldCBpc1Jlc3BvbnNlTG9nZ2VkID0gZmFsc2U7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHtkYXRhLCBzdGF0dXMsIGhlYWRlcnN9ID0gYXdhaXQgdGhpcy5yZXF1ZXN0KHJlcU9wdHMpO1xuICAgICAgLy8gYGRhdGFgIG1pZ2h0IGJlIHJlYWxseSBiaWdcbiAgICAgIC8vIEJlIGNhcmVmdWwgd2hpbGUgaGFuZGxpbmcgaXQgdG8gYXZvaWQgbWVtb3J5IGxlYWtzXG4gICAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChkYXRhKSkge1xuICAgICAgICAvLyBUaGUgcmVzcG9uc2Ugc2hvdWxkIGJlIGEgdmFsaWQgSlNPTiBvYmplY3RcbiAgICAgICAgLy8gSWYgaXQgY2Fubm90IGJlIGNvZXJjZWQgdG8gYW4gb2JqZWN0IHRoZW4gdGhlIHJlc3BvbnNlIGlzIHdyb25nXG4gICAgICAgIHRocm93UHJveHlFcnJvcihkYXRhKTtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhgR290IHJlc3BvbnNlIHdpdGggc3RhdHVzICR7c3RhdHVzfTogJHt0cnVuY2F0ZUJvZHkoZGF0YSl9YCk7XG4gICAgICBpc1Jlc3BvbnNlTG9nZ2VkID0gdHJ1ZTtcbiAgICAgIGNvbnN0IGlzU2Vzc2lvbkNyZWF0aW9uUmVxdWVzdCA9IC9cXC9zZXNzaW9uJC8udGVzdCh1cmwpICYmIG1ldGhvZCA9PT0gJ1BPU1QnO1xuICAgICAgaWYgKGlzU2Vzc2lvbkNyZWF0aW9uUmVxdWVzdCkge1xuICAgICAgICBpZiAoc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICB0aGlzLnNlc3Npb25JZCA9IGRhdGEuc2Vzc2lvbklkIHx8IChkYXRhLnZhbHVlIHx8IHt9KS5zZXNzaW9uSWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgPSB0aGlzLmdldFByb3RvY29sRnJvbVJlc0JvZHkoZGF0YSk7XG4gICAgICAgIGxvZy5pbmZvKGBEZXRlcm1pbmVkIHRoZSBkb3duc3RyZWFtIHByb3RvY29sIGFzICcke3RoaXMuZG93bnN0cmVhbVByb3RvY29sfSdgKTtcbiAgICAgIH1cbiAgICAgIGlmIChfLmhhcyhkYXRhLCAnc3RhdHVzJykgJiYgcGFyc2VJbnQoZGF0YS5zdGF0dXMsIDEwKSAhPT0gMCkge1xuICAgICAgICAvLyBTb21lIHNlcnZlcnMsIGxpa2UgY2hyb21lZHJpdmVyIG1heSByZXR1cm4gcmVzcG9uc2UgY29kZSAyMDAgZm9yIG5vbi16ZXJvIEpTT05XUCBzdGF0dXNlc1xuICAgICAgICB0aHJvd1Byb3h5RXJyb3IoZGF0YSk7XG4gICAgICB9XG4gICAgICBjb25zdCByZXMgPSB7c3RhdHVzQ29kZTogc3RhdHVzLCBoZWFkZXJzLCBib2R5OiBkYXRhfTtcbiAgICAgIHJldHVybiBbcmVzLCBkYXRhXTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAvLyBXZSBvbmx5IGNvbnNpZGVyIGFuIGVycm9yIHVuZXhwZWN0ZWQgaWYgdGhpcyB3YXMgbm90XG4gICAgICAvLyBhbiBhc3luYyByZXF1ZXN0IG1vZHVsZSBlcnJvciBvciBpZiB0aGUgcmVzcG9uc2UgY2Fubm90IGJlIGNhc3QgdG9cbiAgICAgIC8vIGEgdmFsaWQgSlNPTlxuICAgICAgbGV0IHByb3h5RXJyb3JNc2cgPSBlLm1lc3NhZ2U7XG4gICAgICBpZiAodXRpbC5oYXNWYWx1ZShlLnJlc3BvbnNlKSkge1xuICAgICAgICBpZiAoIWlzUmVzcG9uc2VMb2dnZWQpIHtcbiAgICAgICAgICBjb25zdCBlcnJvciA9IHRydW5jYXRlQm9keShlLnJlc3BvbnNlLmRhdGEpO1xuICAgICAgICAgIGxvZy5pbmZvKHV0aWwuaGFzVmFsdWUoZS5yZXNwb25zZS5zdGF0dXMpXG4gICAgICAgICAgICA/IGBHb3QgcmVzcG9uc2Ugd2l0aCBzdGF0dXMgJHtlLnJlc3BvbnNlLnN0YXR1c306ICR7ZXJyb3J9YFxuICAgICAgICAgICAgOiBgR290IHJlc3BvbnNlIHdpdGggdW5rbm93biBzdGF0dXM6ICR7ZXJyb3J9YCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByb3h5RXJyb3JNc2cgPSBgQ291bGQgbm90IHByb3h5IGNvbW1hbmQgdG8gdGhlIHJlbW90ZSBzZXJ2ZXIuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gO1xuICAgICAgICBsb2cud2FybihlLm1lc3NhZ2UpO1xuICAgICAgICBsb2cuZGVidWcoZS5zdGFjayk7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlByb3h5UmVxdWVzdEVycm9yKHByb3h5RXJyb3JNc2csIGUucmVzcG9uc2U/LmRhdGEsIGUucmVzcG9uc2U/LnN0YXR1cyk7XG4gICAgfVxuICB9XG5cbiAgZ2V0UHJvdG9jb2xGcm9tUmVzQm9keSAocmVzT2JqKSB7XG4gICAgaWYgKF8uaXNJbnRlZ2VyKHJlc09iai5zdGF0dXMpKSB7XG4gICAgICByZXR1cm4gTUpTT05XUDtcbiAgICB9XG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHJlc09iai52YWx1ZSkpIHtcbiAgICAgIHJldHVybiBXM0M7XG4gICAgfVxuICB9XG5cbiAgcmVxdWVzdFRvQ29tbWFuZE5hbWUgKHVybCwgbWV0aG9kKSB7XG4gICAgY29uc3QgZXh0cmFjdENvbW1hbmROYW1lID0gKHBhdHRlcm4pID0+IHtcbiAgICAgIGNvbnN0IHBhdGhNYXRjaCA9IHBhdHRlcm4uZXhlYyh1cmwpO1xuICAgICAgcmV0dXJuIHBhdGhNYXRjaCA/IHJvdXRlVG9Db21tYW5kTmFtZShwYXRoTWF0Y2hbMV0sIG1ldGhvZCwgdGhpcy5yZXFCYXNlUGF0aCkgOiBudWxsO1xuICAgIH07XG4gICAgbGV0IGNvbW1hbmROYW1lID0gcm91dGVUb0NvbW1hbmROYW1lKHVybCwgbWV0aG9kLCB0aGlzLnJlcUJhc2VQYXRoKTtcbiAgICBpZiAoIWNvbW1hbmROYW1lICYmIF8uaW5jbHVkZXModXJsLCBgJHt0aGlzLnJlcUJhc2VQYXRofS9zZXNzaW9uL2ApKSB7XG4gICAgICBjb21tYW5kTmFtZSA9IGV4dHJhY3RDb21tYW5kTmFtZShuZXcgUmVnRXhwKGAke18uZXNjYXBlUmVnRXhwKHRoaXMucmVxQmFzZVBhdGgpfS9zZXNzaW9uL1teL10rKC4rKWApKTtcbiAgICB9XG4gICAgaWYgKCFjb21tYW5kTmFtZSAmJiBfLmluY2x1ZGVzKHVybCwgdGhpcy5yZXFCYXNlUGF0aCkpIHtcbiAgICAgIGNvbW1hbmROYW1lID0gZXh0cmFjdENvbW1hbmROYW1lKG5ldyBSZWdFeHAoYCR7Xy5lc2NhcGVSZWdFeHAodGhpcy5yZXFCYXNlUGF0aCl9KC8uKylgKSk7XG4gICAgfVxuICAgIHJldHVybiBjb21tYW5kTmFtZTtcbiAgfVxuXG4gIGFzeW5jIHByb3h5Q29tbWFuZCAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgY29uc3QgY29tbWFuZE5hbWUgPSB0aGlzLnJlcXVlc3RUb0NvbW1hbmROYW1lKHVybCwgbWV0aG9kKTtcbiAgICBpZiAoIWNvbW1hbmROYW1lKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eSh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgTWF0Y2hlZCAnJHt1cmx9JyB0byBjb21tYW5kIG5hbWUgJyR7Y29tbWFuZE5hbWV9J2ApO1xuXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJvdG9jb2xDb252ZXJ0ZXIuY29udmVydEFuZFByb3h5KGNvbW1hbmROYW1lLCB1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cblxuICBhc3luYyBjb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBsZXQgcmVzcG9uc2U7XG4gICAgbGV0IHJlc0JvZHlPYmo7XG4gICAgdHJ5IHtcbiAgICAgIFtyZXNwb25zZSwgcmVzQm9keU9ial0gPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoaXNFcnJvclR5cGUoZXJyLCBlcnJvcnMuUHJveHlSZXF1ZXN0RXJyb3IpKSB7XG4gICAgICAgIHRocm93IGVyci5nZXRBY3R1YWxFcnJvcigpO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoZXJyLm1lc3NhZ2UpO1xuICAgIH1cbiAgICBjb25zdCBwcm90b2NvbCA9IHRoaXMuZ2V0UHJvdG9jb2xGcm9tUmVzQm9keShyZXNCb2R5T2JqKTtcbiAgICBpZiAocHJvdG9jb2wgPT09IE1KU09OV1ApIHtcbiAgICAgIC8vIEdvdCByZXNwb25zZSBpbiBNSlNPTldQIGZvcm1hdFxuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCAmJiByZXNCb2R5T2JqLnN0YXR1cyA9PT0gMCkge1xuICAgICAgICByZXR1cm4gcmVzQm9keU9iai52YWx1ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHN0YXR1cyA9IHBhcnNlSW50KHJlc0JvZHlPYmouc3RhdHVzLCAxMCk7XG4gICAgICBpZiAoIWlzTmFOKHN0YXR1cykgJiYgc3RhdHVzICE9PSAwKSB7XG4gICAgICAgIGxldCBtZXNzYWdlID0gcmVzQm9keU9iai52YWx1ZTtcbiAgICAgICAgaWYgKF8uaGFzKG1lc3NhZ2UsICdtZXNzYWdlJykpIHtcbiAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZS5tZXNzYWdlO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlKHN0YXR1cywgXy5pc0VtcHR5KG1lc3NhZ2UpID8gZ2V0U3VtbWFyeUJ5Q29kZShzdGF0dXMpIDogbWVzc2FnZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChwcm90b2NvbCA9PT0gVzNDKSB7XG4gICAgICAvLyBHb3QgcmVzcG9uc2UgaW4gVzNDIGZvcm1hdFxuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPCAzMDApIHtcbiAgICAgICAgcmV0dXJuIHJlc0JvZHlPYmoudmFsdWU7XG4gICAgICB9XG4gICAgICBpZiAoXy5pc1BsYWluT2JqZWN0KHJlc0JvZHlPYmoudmFsdWUpICYmIHJlc0JvZHlPYmoudmFsdWUuZXJyb3IpIHtcbiAgICAgICAgdGhyb3cgZXJyb3JGcm9tVzNDSnNvbkNvZGUocmVzQm9keU9iai52YWx1ZS5lcnJvciwgcmVzQm9keU9iai52YWx1ZS5tZXNzYWdlLCByZXNCb2R5T2JqLnZhbHVlLnN0YWNrdHJhY2UpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAvLyBVbmtub3duIHByb3RvY29sLiBLZWVwaW5nIGl0IGJlY2F1c2Ugb2YgdGhlIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICAgIHJldHVybiByZXNCb2R5T2JqO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRGlkIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCByZXNwb25zZSBjb2RlICcke3Jlc3BvbnNlLnN0YXR1c0NvZGV9JyBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgYW5kIHJlc3BvbnNlIGJvZHkgJyR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShyZXNCb2R5T2JqKSwge2xlbmd0aDogMzAwfSl9J2ApO1xuICB9XG5cbiAgZ2V0U2Vzc2lvbklkRnJvbVVybCAodXJsKSB7XG4gICAgY29uc3QgbWF0Y2ggPSB1cmwubWF0Y2goL1xcL3Nlc3Npb25cXC8oW14vXSspLyk7XG4gICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBudWxsO1xuICB9XG5cbiAgYXN5bmMgcHJveHlSZXFSZXMgKHJlcSwgcmVzKSB7XG4gICAgY29uc3QgW3Jlc3BvbnNlLCByZXNCb2R5T2JqXSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKHJlcS5vcmlnaW5hbFVybCwgcmVxLm1ldGhvZCwgcmVxLmJvZHkpO1xuXG4gICAgcmVzLmhlYWRlcnMgPSByZXNwb25zZS5oZWFkZXJzO1xuICAgIHJlcy5zZXQoJ2NvbnRlbnQtdHlwZScsIHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddKTtcbiAgICAvLyBpZiB0aGUgcHJveGllZCByZXNwb25zZSBjb250YWlucyBhIHNlc3Npb25JZCB0aGF0IHRoZSBkb3duc3RyZWFtXG4gICAgLy8gZHJpdmVyIGhhcyBnZW5lcmF0ZWQsIHdlIGRvbid0IHdhbnQgdG8gcmV0dXJuIHRoYXQgdG8gdGhlIGNsaWVudC5cbiAgICAvLyBJbnN0ZWFkLCByZXR1cm4gdGhlIGlkIGZyb20gdGhlIHJlcXVlc3Qgb3IgZnJvbSBjdXJyZW50IHNlc3Npb25cbiAgICBjb25zdCByZXFTZXNzaW9uSWQgPSB0aGlzLmdldFNlc3Npb25JZEZyb21VcmwocmVxLm9yaWdpbmFsVXJsKTtcbiAgICBpZiAoXy5oYXMocmVzQm9keU9iaiwgJ3Nlc3Npb25JZCcpKSB7XG4gICAgICBpZiAocmVxU2Vzc2lvbklkKSB7XG4gICAgICAgIGxvZy5pbmZvKGBSZXBsYWNpbmcgc2Vzc2lvbklkICR7cmVzQm9keU9iai5zZXNzaW9uSWR9IHdpdGggJHtyZXFTZXNzaW9uSWR9YCk7XG4gICAgICAgIHJlc0JvZHlPYmouc2Vzc2lvbklkID0gcmVxU2Vzc2lvbklkO1xuICAgICAgfSBlbHNlIGlmICh0aGlzLnNlc3Npb25JZCkge1xuICAgICAgICBsb2cuaW5mbyhgUmVwbGFjaW5nIHNlc3Npb25JZCAke3Jlc0JvZHlPYmouc2Vzc2lvbklkfSB3aXRoICR7dGhpcy5zZXNzaW9uSWR9YCk7XG4gICAgICAgIHJlc0JvZHlPYmouc2Vzc2lvbklkID0gdGhpcy5zZXNzaW9uSWQ7XG4gICAgICB9XG4gICAgfVxuICAgIHJlc0JvZHlPYmoudmFsdWUgPSBmb3JtYXRSZXNwb25zZVZhbHVlKHJlc0JvZHlPYmoudmFsdWUpO1xuICAgIGZvcm1hdFN0YXR1cyhyZXNCb2R5T2JqLCByZXMuc3RhdHVzQ29kZSwgU0VTU0lPTlNfQ0FDSEUuZ2V0UHJvdG9jb2wocmVxU2Vzc2lvbklkKSk7XG4gICAgcmVzLnN0YXR1cyhyZXNwb25zZS5zdGF0dXNDb2RlKS5zZW5kKEpTT04uc3RyaW5naWZ5KHJlc0JvZHlPYmopKTtcbiAgfVxufVxuXG5leHBvcnQgeyBKV1Byb3h5IH07XG5leHBvcnQgZGVmYXVsdCBKV1Byb3h5O1xuIl0sImZpbGUiOiJsaWIvanNvbndwLXByb3h5L3Byb3h5LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
