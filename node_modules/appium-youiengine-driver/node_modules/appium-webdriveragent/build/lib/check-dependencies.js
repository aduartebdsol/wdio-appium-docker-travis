"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.checkForDependencies = checkForDependencies;
exports.bundleWDASim = bundleWDASim;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _nodeSimctl = _interopRequireDefault(require("node-simctl"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _os = require("os");

var _utils = require("./utils");

var _xcodebuild = _interopRequireDefault(require("./xcodebuild"));

var _constants = require("./constants");

var _logger = _interopRequireDefault(require("./logger"));

const execLogger = {
  logNonEmptyLines(data, fn) {
    data = Buffer.isBuffer(data) ? data.toString() : data;

    for (const line of data.split(_os.EOL)) {
      if (line) {
        fn(line);
      }
    }
  },

  debug(data) {
    this.logNonEmptyLines(data, _logger.default.debug.bind(_logger.default));
  },

  error(data) {
    this.logNonEmptyLines(data, _logger.default.error.bind(_logger.default));
  }

};
const IOS = 'iOS';
const TVOS = 'tvOS';
const CARTHAGE_CMD = 'carthage';
const CARTFILE = 'Cartfile.resolved';

async function hasTvOSSims() {
  const devices = _lodash.default.flatten(Object.values(await new _nodeSimctl.default().getDevices(null, TVOS)));

  return !_lodash.default.isEmpty(devices);
}

function getCartfileLocations() {
  const cartfile = _path.default.resolve(_constants.BOOTSTRAP_PATH, CARTFILE);

  const installedCartfile = _path.default.resolve(_constants.BOOTSTRAP_PATH, _constants.CARTHAGE_ROOT, CARTFILE);

  return {
    cartfile,
    installedCartfile
  };
}

async function needsUpdate(cartfile, installedCartfile) {
  return !(await (0, _utils.fileCompare)(cartfile, installedCartfile));
}

async function fetchDependencies(useSsl = false) {
  _logger.default.info('Fetching dependencies');

  if (!(await _appiumSupport.fs.which(CARTHAGE_CMD))) {
    _logger.default.errorAndThrow('Please make sure that you have Carthage installed ' + '(https://github.com/Carthage/Carthage), and that it is ' + 'available in the PATH for the environment running Appium');
  }

  const {
    cartfile,
    installedCartfile
  } = getCartfileLocations();

  if (!(await needsUpdate(cartfile, installedCartfile))) {
    _logger.default.info('Dependencies up-to-date');

    return false;
  }

  let platforms = [IOS];

  if (await hasTvOSSims()) {
    platforms.push(TVOS);
  } else {
    _logger.default.debug('tvOS platform will not be included into Carthage bootstrap, because no Simulator devices have been created for it');
  }

  _logger.default.info(`Installing/updating dependencies for platforms ${platforms.map(p => `'${p}'`).join(', ')}`);

  let args = ['bootstrap'];

  if (useSsl) {
    args.push('--use-ssh');
  }

  args.push('--platform', platforms.join(','));

  try {
    await (0, _teen_process.exec)(CARTHAGE_CMD, args, {
      logger: execLogger,
      cwd: _constants.BOOTSTRAP_PATH
    });
  } catch (err) {
    await _appiumSupport.fs.rimraf(_path.default.resolve(_constants.BOOTSTRAP_PATH, _constants.CARTHAGE_ROOT));
    throw err;
  }

  await _appiumSupport.fs.copyFile(cartfile, installedCartfile);

  _logger.default.debug(`Finished fetching dependencies`);

  return true;
}

async function buildWDASim() {
  const args = ['-project', _constants.WDA_PROJECT, '-scheme', _constants.WDA_SCHEME, '-sdk', _constants.SDK_SIMULATOR, 'CODE_SIGN_IDENTITY=""', 'CODE_SIGNING_REQUIRED="NO"', 'GCC_TREAT_WARNINGS_AS_ERRORS=0'];
  await (0, _teen_process.exec)('xcodebuild', args);
}

async function checkForDependencies(opts = {}) {
  return await fetchDependencies(opts.useSsl);
}

async function bundleWDASim(xcodebuild, opts = {}) {
  if (xcodebuild && !_lodash.default.isFunction(xcodebuild.retrieveDerivedDataPath)) {
    xcodebuild = new _xcodebuild.default();
    opts = xcodebuild;
  }

  const derivedDataPath = await xcodebuild.retrieveDerivedDataPath();

  const wdaBundlePath = _path.default.join(derivedDataPath, 'Build', 'Products', 'Debug-iphonesimulator', _constants.WDA_RUNNER_APP);

  if (await _appiumSupport.fs.exists(wdaBundlePath)) {
    return wdaBundlePath;
  }

  await checkForDependencies(opts);
  await buildWDASim(xcodebuild, opts);
  return wdaBundlePath;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jaGVjay1kZXBlbmRlbmNpZXMuanMiXSwibmFtZXMiOlsiZXhlY0xvZ2dlciIsImxvZ05vbkVtcHR5TGluZXMiLCJkYXRhIiwiZm4iLCJCdWZmZXIiLCJpc0J1ZmZlciIsInRvU3RyaW5nIiwibGluZSIsInNwbGl0IiwiRU9MIiwiZGVidWciLCJsb2ciLCJiaW5kIiwiZXJyb3IiLCJJT1MiLCJUVk9TIiwiQ0FSVEhBR0VfQ01EIiwiQ0FSVEZJTEUiLCJoYXNUdk9TU2ltcyIsImRldmljZXMiLCJfIiwiZmxhdHRlbiIsIk9iamVjdCIsInZhbHVlcyIsIlNpbWN0bCIsImdldERldmljZXMiLCJpc0VtcHR5IiwiZ2V0Q2FydGZpbGVMb2NhdGlvbnMiLCJjYXJ0ZmlsZSIsInBhdGgiLCJyZXNvbHZlIiwiQk9PVFNUUkFQX1BBVEgiLCJpbnN0YWxsZWRDYXJ0ZmlsZSIsIkNBUlRIQUdFX1JPT1QiLCJuZWVkc1VwZGF0ZSIsImZldGNoRGVwZW5kZW5jaWVzIiwidXNlU3NsIiwiaW5mbyIsImZzIiwid2hpY2giLCJlcnJvckFuZFRocm93IiwicGxhdGZvcm1zIiwicHVzaCIsIm1hcCIsInAiLCJqb2luIiwiYXJncyIsImxvZ2dlciIsImN3ZCIsImVyciIsInJpbXJhZiIsImNvcHlGaWxlIiwiYnVpbGRXREFTaW0iLCJXREFfUFJPSkVDVCIsIldEQV9TQ0hFTUUiLCJTREtfU0lNVUxBVE9SIiwiY2hlY2tGb3JEZXBlbmRlbmNpZXMiLCJvcHRzIiwiYnVuZGxlV0RBU2ltIiwieGNvZGVidWlsZCIsImlzRnVuY3Rpb24iLCJyZXRyaWV2ZURlcml2ZWREYXRhUGF0aCIsIlhjb2RlQnVpbGQiLCJkZXJpdmVkRGF0YVBhdGgiLCJ3ZGFCdW5kbGVQYXRoIiwiV0RBX1JVTk5FUl9BUFAiLCJleGlzdHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUlBOztBQUdBLE1B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QUFOLENBQTlCO0FBQ0Q7O0FBRUQsZUFBZXNCLFlBQWYsQ0FBNkJDLFVBQTdCLEVBQXlDRixJQUFJLEdBQUcsRUFBaEQsRUFBb0Q7QUFDbEQsTUFBSUUsVUFBVSxJQUFJLENBQUN2QyxnQkFBRXdDLFVBQUYsQ0FBYUQsVUFBVSxDQUFDRSx1QkFBeEIsQ0FBbkIsRUFBcUU7QUFDbkVGLElBQUFBLFVBQVUsR0FBRyxJQUFJRyxtQkFBSixFQUFiO0FBQ0FMLElBQUFBLElBQUksR0FBR0UsVUFBUDtBQUNEOztBQUVELFFBQU1JLGVBQWUsR0FBRyxNQUFNSixVQUFVLENBQUNFLHVCQUFYLEVBQTlCOztBQUNBLFFBQU1HLGFBQWEsR0FBR25DLGNBQUtnQixJQUFMLENBQVVrQixlQUFWLEVBQTJCLE9BQTNCLEVBQW9DLFVBQXBDLEVBQWdELHVCQUFoRCxFQUF5RUUseUJBQXpFLENBQXRCOztBQUNBLE1BQUksTUFBTTNCLGtCQUFHNEIsTUFBSCxDQUFVRixhQUFWLENBQVYsRUFBb0M7QUFDbEMsV0FBT0EsYUFBUDtBQUNEOztBQUNELFFBQU1SLG9CQUFvQixDQUFDQyxJQUFELENBQTFCO0FBQ0EsUUFBTUwsV0FBVyxDQUFDTyxVQUFELEVBQWFGLElBQWIsQ0FBakI7QUFDQSxTQUFPTyxhQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcyB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBTaW1jdGwgZnJvbSAnbm9kZS1zaW1jdGwnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcyc7XG5pbXBvcnQgeyBmaWxlQ29tcGFyZSB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IFhjb2RlQnVpbGQgZnJvbSAnLi94Y29kZWJ1aWxkJztcbmltcG9ydCB7XG4gIEJPT1RTVFJBUF9QQVRILCBXREFfUFJPSkVDVCwgV0RBX1NDSEVNRSwgQ0FSVEhBR0VfUk9PVCwgU0RLX1NJTVVMQVRPUixcbiAgV0RBX1JVTk5FUl9BUFAsXG59IGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuXG5cbmNvbnN0IGV4ZWNMb2dnZXIgPSB7XG4gIC8vIGxvZ2dlciB0aGF0IGdldHMgcmlkIG9mIGVtcHR5IGxpbmVzXG4gIGxvZ05vbkVtcHR5TGluZXMgKGRhdGEsIGZuKSB7XG4gICAgZGF0YSA9IEJ1ZmZlci5pc0J1ZmZlcihkYXRhKSA/IGRhdGEudG9TdHJpbmcoKSA6IGRhdGE7XG4gICAgZm9yIChjb25zdCBsaW5lIG9mIGRhdGEuc3BsaXQoRU9MKSkge1xuICAgICAgaWYgKGxpbmUpIHtcbiAgICAgICAgZm4obGluZSk7XG4gICAgICB9XG4gICAgfVxuICB9LFxuICBkZWJ1ZyAoZGF0YSkge1xuICAgIHRoaXMubG9nTm9uRW1wdHlMaW5lcyhkYXRhLCBsb2cuZGVidWcuYmluZChsb2cpKTtcbiAgfSxcbiAgZXJyb3IgKGRhdGEpIHtcbiAgICB0aGlzLmxvZ05vbkVtcHR5TGluZXMoZGF0YSwgbG9nLmVycm9yLmJpbmQobG9nKSk7XG4gIH0sXG59O1xuXG5jb25zdCBJT1MgPSAnaU9TJztcbmNvbnN0IFRWT1MgPSAndHZPUyc7XG5cbmNvbnN0IENBUlRIQUdFX0NNRCA9ICdjYXJ0aGFnZSc7XG5jb25zdCBDQVJURklMRSA9ICdDYXJ0ZmlsZS5yZXNvbHZlZCc7XG5cbmFzeW5jIGZ1bmN0aW9uIGhhc1R2T1NTaW1zICgpIHtcbiAgY29uc3QgZGV2aWNlcyA9IF8uZmxhdHRlbihPYmplY3QudmFsdWVzKGF3YWl0IG5ldyBTaW1jdGwoKS5nZXREZXZpY2VzKG51bGwsIFRWT1MpKSk7XG4gIHJldHVybiAhXy5pc0VtcHR5KGRldmljZXMpO1xufVxuXG5mdW5jdGlvbiBnZXRDYXJ0ZmlsZUxvY2F0aW9ucyAoKSB7XG4gIGNvbnN0IGNhcnRmaWxlID0gcGF0aC5yZXNvbHZlKEJPT1RTVFJBUF9QQVRILCBDQVJURklMRSk7XG4gIGNvbnN0IGluc3RhbGxlZENhcnRmaWxlID0gcGF0aC5yZXNvbHZlKEJPT1RTVFJBUF9QQVRILCBDQVJUSEFHRV9ST09ULCBDQVJURklMRSk7XG5cbiAgcmV0dXJuIHtcbiAgICBjYXJ0ZmlsZSxcbiAgICBpbnN0YWxsZWRDYXJ0ZmlsZSxcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbmVlZHNVcGRhdGUgKGNhcnRmaWxlLCBpbnN0YWxsZWRDYXJ0ZmlsZSkge1xuICByZXR1cm4gIWF3YWl0IGZpbGVDb21wYXJlKGNhcnRmaWxlLCBpbnN0YWxsZWRDYXJ0ZmlsZSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZldGNoRGVwZW5kZW5jaWVzICh1c2VTc2wgPSBmYWxzZSkge1xuICBsb2cuaW5mbygnRmV0Y2hpbmcgZGVwZW5kZW5jaWVzJyk7XG4gIGlmICghYXdhaXQgZnMud2hpY2goQ0FSVEhBR0VfQ01EKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KCdQbGVhc2UgbWFrZSBzdXJlIHRoYXQgeW91IGhhdmUgQ2FydGhhZ2UgaW5zdGFsbGVkICcgK1xuICAgICAgICAgICAgICAgICAgICAgICcoaHR0cHM6Ly9naXRodWIuY29tL0NhcnRoYWdlL0NhcnRoYWdlKSwgYW5kIHRoYXQgaXQgaXMgJyArXG4gICAgICAgICAgICAgICAgICAgICAgJ2F2YWlsYWJsZSBpbiB0aGUgUEFUSCBmb3IgdGhlIGVudmlyb25tZW50IHJ1bm5pbmcgQXBwaXVtJyk7XG4gIH1cblxuICAvLyBjaGVjayB0aGF0IHRoZSBkZXBlbmRlbmNpZXMgZG8gbm90IG5lZWQgdG8gYmUgdXBkYXRlZFxuICBjb25zdCB7XG4gICAgY2FydGZpbGUsXG4gICAgaW5zdGFsbGVkQ2FydGZpbGUsXG4gIH0gPSBnZXRDYXJ0ZmlsZUxvY2F0aW9ucygpO1xuXG4gIGlmICghYXdhaXQgbmVlZHNVcGRhdGUoY2FydGZpbGUsIGluc3RhbGxlZENhcnRmaWxlKSkge1xuICAgIC8vIGZpbGVzIGFyZSBpZGVudGljYWxcbiAgICBsb2cuaW5mbygnRGVwZW5kZW5jaWVzIHVwLXRvLWRhdGUnKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBsZXQgcGxhdGZvcm1zID0gW0lPU107XG4gIGlmIChhd2FpdCBoYXNUdk9TU2ltcygpKSB7XG4gICAgcGxhdGZvcm1zLnB1c2goVFZPUyk7XG4gIH0gZWxzZSB7XG4gICAgbG9nLmRlYnVnKCd0dk9TIHBsYXRmb3JtIHdpbGwgbm90IGJlIGluY2x1ZGVkIGludG8gQ2FydGhhZ2UgYm9vdHN0cmFwLCBiZWNhdXNlIG5vIFNpbXVsYXRvciBkZXZpY2VzIGhhdmUgYmVlbiBjcmVhdGVkIGZvciBpdCcpO1xuICB9XG5cbiAgbG9nLmluZm8oYEluc3RhbGxpbmcvdXBkYXRpbmcgZGVwZW5kZW5jaWVzIGZvciBwbGF0Zm9ybXMgJHtwbGF0Zm9ybXMubWFwKChwKSA9PiBgJyR7cH0nYCkuam9pbignLCAnKX1gKTtcblxuICBsZXQgYXJncyA9IFsnYm9vdHN0cmFwJ107XG4gIGlmICh1c2VTc2wpIHtcbiAgICBhcmdzLnB1c2goJy0tdXNlLXNzaCcpO1xuICB9XG4gIGFyZ3MucHVzaCgnLS1wbGF0Zm9ybScsIHBsYXRmb3Jtcy5qb2luKCcsJykpO1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoQ0FSVEhBR0VfQ01ELCBhcmdzLCB7XG4gICAgICBsb2dnZXI6IGV4ZWNMb2dnZXIsXG4gICAgICBjd2Q6IEJPT1RTVFJBUF9QQVRILFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyByZW1vdmUgdGhlIGNhcnRoYWdlIGRpcmVjdG9yeSwgb3IgZWxzZSBzdWJzZXF1ZW50IHJ1bnMgd2lsbCBzZWUgaXQgYW5kXG4gICAgLy8gYXNzdW1lIHRoZSBkZXBlbmRlbmNpZXMgYXJlIGFscmVhZHkgZG93bmxvYWRlZFxuICAgIGF3YWl0IGZzLnJpbXJhZihwYXRoLnJlc29sdmUoQk9PVFNUUkFQX1BBVEgsIENBUlRIQUdFX1JPT1QpKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cblxuICAvLyBwdXQgdGhlIHJlc29sdmVkIGNhcnRmaWxlIGludG8gdGhlIENhcnRoYWdlIGRpcmVjdG9yeVxuICBhd2FpdCBmcy5jb3B5RmlsZShjYXJ0ZmlsZSwgaW5zdGFsbGVkQ2FydGZpbGUpO1xuXG4gIGxvZy5kZWJ1ZyhgRmluaXNoZWQgZmV0Y2hpbmcgZGVwZW5kZW5jaWVzYCk7XG4gIHJldHVybiB0cnVlO1xufVxuXG5hc3luYyBmdW5jdGlvbiBidWlsZFdEQVNpbSAoKSB7XG4gIGNvbnN0IGFyZ3MgPSBbXG4gICAgJy1wcm9qZWN0JywgV0RBX1BST0pFQ1QsXG4gICAgJy1zY2hlbWUnLCBXREFfU0NIRU1FLFxuICAgICctc2RrJywgU0RLX1NJTVVMQVRPUixcbiAgICAnQ09ERV9TSUdOX0lERU5USVRZPVwiXCInLFxuICAgICdDT0RFX1NJR05JTkdfUkVRVUlSRUQ9XCJOT1wiJyxcbiAgICAnR0NDX1RSRUFUX1dBUk5JTkdTX0FTX0VSUk9SUz0wJyxcbiAgXTtcbiAgYXdhaXQgZXhlYygneGNvZGVidWlsZCcsIGFyZ3MpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja0ZvckRlcGVuZGVuY2llcyAob3B0cyA9IHt9KSB7XG4gIHJldHVybiBhd2FpdCBmZXRjaERlcGVuZGVuY2llcyhvcHRzLnVzZVNzbCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGJ1bmRsZVdEQVNpbSAoeGNvZGVidWlsZCwgb3B0cyA9IHt9KSB7XG4gIGlmICh4Y29kZWJ1aWxkICYmICFfLmlzRnVuY3Rpb24oeGNvZGVidWlsZC5yZXRyaWV2ZURlcml2ZWREYXRhUGF0aCkpIHtcbiAgICB4Y29kZWJ1aWxkID0gbmV3IFhjb2RlQnVpbGQoKTtcbiAgICBvcHRzID0geGNvZGVidWlsZDtcbiAgfVxuXG4gIGNvbnN0IGRlcml2ZWREYXRhUGF0aCA9IGF3YWl0IHhjb2RlYnVpbGQucmV0cmlldmVEZXJpdmVkRGF0YVBhdGgoKTtcbiAgY29uc3Qgd2RhQnVuZGxlUGF0aCA9IHBhdGguam9pbihkZXJpdmVkRGF0YVBhdGgsICdCdWlsZCcsICdQcm9kdWN0cycsICdEZWJ1Zy1pcGhvbmVzaW11bGF0b3InLCBXREFfUlVOTkVSX0FQUCk7XG4gIGlmIChhd2FpdCBmcy5leGlzdHMod2RhQnVuZGxlUGF0aCkpIHtcbiAgICByZXR1cm4gd2RhQnVuZGxlUGF0aDtcbiAgfVxuICBhd2FpdCBjaGVja0ZvckRlcGVuZGVuY2llcyhvcHRzKTtcbiAgYXdhaXQgYnVpbGRXREFTaW0oeGNvZGVidWlsZCwgb3B0cyk7XG4gIHJldHVybiB3ZGFCdW5kbGVQYXRoO1xufVxuXG5leHBvcnQgeyBjaGVja0ZvckRlcGVuZGVuY2llcywgYnVuZGxlV0RBU2ltIH07XG4iXSwiZmlsZSI6ImxpYi9jaGVjay1kZXBlbmRlbmNpZXMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
